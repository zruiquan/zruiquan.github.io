<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="第0章 RPC通信原理解析0）回顾  1）需求： ​    模拟RPC的客户端、服务端、通信协议三者如何工作的">
<meta property="og:type" content="article">
<meta property="og:title" content="Hadoop之源码解析">
<meta property="og:url" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="没有尾巴的小驴">
<meta property="og:description" content="第0章 RPC通信原理解析0）回顾  1）需求： ​    模拟RPC的客户端、服务端、通信协议三者如何工作的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808162817900.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808162827317.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808163050715.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808163113279.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808164121857.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808164153531.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808165138080.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808165240958.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808170544341.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808170600803.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171345335.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171431731.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171608932.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171631745.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171654094.png">
<meta property="og:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808172319416.png">
<meta property="article:published_time" content="2022-08-08T06:53:58.000Z">
<meta property="article:modified_time" content="2025-06-25T08:08:45.553Z">
<meta property="article:author" content="Rui Zhang">
<meta property="article:tag" content="Hadoop">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808162817900.png">

<link rel="canonical" href="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>Hadoop之源码解析 | 没有尾巴的小驴</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">没有尾巴的小驴</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">记录生活</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">22</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">22</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">52</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="Rui Zhang">
      <meta itemprop="description" content="不在沉默中爆发，就在沉默中灭亡">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="没有尾巴的小驴">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hadoop之源码解析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-08 14:53:58" itemprop="dateCreated datePublished" datetime="2022-08-08T14:53:58+08:00">2022-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-25 16:08:45" itemprop="dateModified" datetime="2025-06-25T16:08:45+08:00">2025-06-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index"><span itemprop="name">Hadoop</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>114k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:44</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="第0章-RPC通信原理解析"><a href="#第0章-RPC通信原理解析" class="headerlink" title="第0章 RPC通信原理解析"></a>第0章 RPC通信原理解析</h1><p><strong>0）回顾</strong></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808162817900.png" alt="image-20220808162817900"></p>
<p><strong>1）需求：</strong></p>
<p>​    模拟RPC的客户端、服务端、通信协议三者如何工作的</p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808162827317.png" alt="image-20220808162827317"></p>
<p><strong>2）代码编写：</strong></p>
<p>（1）在HDFSClient项目基础上创建包名com.atguigu.rpc</p>
<p>（2）创建RPC协议</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RPCProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> versionID = <span class="number">666</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">mkdirs</span><span class="params">(String path)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）创建RPC服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.ipc.RPC;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.ipc.Server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NNServer</span> <span class="keyword">implements</span> <span class="title">RPCProtocol</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mkdirs</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"服务端，创建路径"</span> + path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Server server = <span class="keyword">new</span> RPC.Builder(<span class="keyword">new</span> Configuration())</span><br><span class="line">                .setBindAddress(<span class="string">"localhost"</span>)</span><br><span class="line">                .setPort(<span class="number">8888</span>)</span><br><span class="line">                .setProtocol(RPCProtocol<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">setInstance</span>(<span class="title">new</span> <span class="title">NNServer</span>())</span></span><br><span class="line"><span class="class">                .<span class="title">build</span>()</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器开始工作"</span>);</span><br><span class="line"></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）创建RPC客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rpc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.ipc.RPC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFSClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RPCProtocol client = RPC.getProxy(</span><br><span class="line">                RPCProtocol<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">RPCProtocol</span>.<span class="title">versionID</span>,</span></span><br><span class="line">                new InetSocketAddress("localhost", 8888),</span><br><span class="line">                <span class="keyword">new</span> Configuration());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"我是客户端"</span>);</span><br><span class="line"></span><br><span class="line">        client.mkdirs(<span class="string">"/input"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）测试</strong></p>
<p>​    （1）启动服务端</p>
<p>观察控制台打印：服务器开始工作</p>
<p>在控制台Terminal窗口输入，jps，查看到NNServer服务</p>
<p>​    （2）启动客户端    </p>
<p>​        观察客户端控制台打印：我是客户端</p>
<p>​        观察服务端控制台打印：服务端，创建路径/input</p>
<p><strong>4）总结</strong></p>
<p>​    RPC的客户端调用通信协议方法，方法的执行在服务端；</p>
<p>​    通信协议就是接口规范。</p>
<h1 id="第1章-NameNode启动源码解析"><a href="#第1章-NameNode启动源码解析" class="headerlink" title="第1章 NameNode启动源码解析"></a>第1章 NameNode启动源码解析</h1><p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808163050715.png" alt="image-20220808163050715"></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808163113279.png" alt="image-20220808163113279"></p>
<p><strong>0）在pom.xml中增加如下依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>1）ctrl + n 全局查找namenode，进入NameNode.java</strong></p>
<p>NameNode官方说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NameNode serves as both directory namespace manager and <span class="string">"inode table"</span> <span class="keyword">for</span> the Hadoop DFS. There is a single NameNode running in any DFS deployment. (Well, except when there is a second backup/failover NameNode, or when using federated NameNodes.) The NameNode controls two critical tables: <span class="number">1</span>) filename-&gt;blocksequence (namespace) <span class="number">2</span>) block-&gt;machinelist (<span class="string">"inodes"</span>) The first table is stored on disk and is very precious. The second table is rebuilt every time the NameNode comes up. <span class="string">'NameNode'</span> refers to both <span class="keyword">this</span> <span class="class"><span class="keyword">class</span> <span class="title">as</span> <span class="title">well</span> <span class="title">as</span> <span class="title">the</span> '<span class="title">NameNode</span> <span class="title">server</span>'. <span class="title">The</span> '<span class="title">FSNamesystem</span>' <span class="title">class</span> <span class="title">actually</span> <span class="title">performs</span> <span class="title">most</span> <span class="title">of</span> <span class="title">the</span> <span class="title">filesystem</span> <span class="title">management</span>. <span class="title">The</span> <span class="title">majority</span> <span class="title">of</span> <span class="title">the</span> '<span class="title">NameNode</span>' <span class="title">class</span> <span class="title">itself</span> <span class="title">is</span> <span class="title">concerned</span> <span class="title">with</span> <span class="title">exposing</span> <span class="title">the</span> <span class="title">IPC</span> <span class="title">interface</span> <span class="title">and</span> <span class="title">the</span> <span class="title">HTTP</span> <span class="title">server</span> <span class="title">to</span> <span class="title">the</span> <span class="title">outside</span> <span class="title">world</span>, <span class="title">plus</span> <span class="title">some</span> <span class="title">configuration</span> <span class="title">management</span>. <span class="title">NameNode</span> <span class="keyword">implements</span> <span class="title">the</span> <span class="title">ClientProtocol</span> <span class="title">interface</span>, <span class="title">which</span> <span class="title">allows</span> <span class="title">clients</span> <span class="title">to</span> <span class="title">ask</span> <span class="title">for</span> <span class="title">DFS</span> <span class="title">services</span>. <span class="title">ClientProtocol</span> <span class="title">is</span> <span class="title">not</span> <span class="title">designed</span> <span class="title">for</span> <span class="title">direct</span> <span class="title">use</span> <span class="title">by</span> <span class="title">authors</span> <span class="title">of</span> <span class="title">DFS</span> <span class="title">client</span> <span class="title">code</span>. <span class="title">End</span>-<span class="title">users</span> <span class="title">should</span> <span class="title">instead</span> <span class="title">use</span> <span class="title">the</span> <span class="title">FileSystem</span> <span class="title">class</span>. <span class="title">NameNode</span> <span class="title">also</span> <span class="keyword">implements</span> <span class="title">the</span> <span class="title">DatanodeProtocol</span> <span class="title">interface</span>, <span class="title">used</span> <span class="title">by</span> <span class="title">DataNodes</span> <span class="title">that</span> <span class="title">actually</span> <span class="title">store</span> <span class="title">DFS</span> <span class="title">data</span> <span class="title">blocks</span>. <span class="title">These</span> <span class="title">methods</span> <span class="title">are</span> <span class="title">invoked</span> <span class="title">repeatedly</span> <span class="title">and</span> <span class="title">automatically</span> <span class="title">by</span> <span class="title">all</span> <span class="title">the</span> <span class="title">DataNodes</span> <span class="title">in</span> <span class="title">a</span> <span class="title">DFS</span> <span class="title">deployment</span>. <span class="title">NameNode</span> <span class="title">also</span> <span class="keyword">implements</span> <span class="title">the</span> <span class="title">NamenodeProtocol</span> <span class="title">interface</span>, <span class="title">used</span> <span class="title">by</span> <span class="title">secondary</span> <span class="title">namenodes</span> <span class="title">or</span> <span class="title">rebalancing</span> <span class="title">processes</span> <span class="title">to</span> <span class="title">get</span> <span class="title">partial</span> <span class="title">NameNode</span> <span class="title">state</span>, <span class="title">for</span> <span class="title">example</span> <span class="title">partial</span> <span class="title">blocksMap</span> <span class="title">etc</span>.</span></span><br></pre></td></tr></table></figure>

<p><strong>2）ctrl + f，查找main方法</strong></p>
<p>NameNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (DFSUtil.parseHelpArgument(argv, NameNode.USAGE, System.out, <span class="keyword">true</span>)) &#123;</span><br><span class="line">		System.exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		StringUtils.startupShutdownMessage(NameNode<span class="class">.<span class="keyword">class</span>, <span class="title">argv</span>, <span class="title">LOG</span>)</span>;</span><br><span class="line">		<span class="comment">// 创建NameNode</span></span><br><span class="line">		NameNode namenode = createNameNode(argv, <span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">if</span> (namenode != <span class="keyword">null</span>) &#123;</span><br><span class="line">			namenode.join();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">		LOG.error(<span class="string">"Failed to start namenode."</span>, e);</span><br><span class="line">		terminate(<span class="number">1</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击createNameNode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NameNode <span class="title">createNameNode</span><span class="params">(String argv[], Configuration conf)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  … …</span><br><span class="line">  StartupOption startOpt = parseArguments(argv);</span><br><span class="line">  <span class="keyword">if</span> (startOpt == <span class="keyword">null</span>) &#123;</span><br><span class="line">    printUsage(System.err);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  setStartupOption(conf, startOpt);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">switch</span> (startOpt) &#123;</span><br><span class="line">  <span class="keyword">case</span> FORMAT:</span><br><span class="line">    aborted = format(conf, startOpt.getForceFormat(),</span><br><span class="line">        startOpt.getInteractiveFormat());</span><br><span class="line">    terminate(aborted ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// avoid javac warning</span></span><br><span class="line">  <span class="keyword">case</span> GENCLUSTERID:</span><br><span class="line">    … …</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    DefaultMetricsSystem.initialize(<span class="string">"NameNode"</span>);</span><br><span class="line">	<span class="comment">// 创建NameNode对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NameNode(conf);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击NameNode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NameNode</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(conf, NamenodeRole.NAMENODE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">NameNode</span><span class="params">(Configuration conf, NamenodeRole role)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    initializeGenericKeys(conf, nsId, namenodeId);</span><br><span class="line">    initialize(getConf());</span><br><span class="line">    ... ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.stopAtException(e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (HadoopIllegalArgumentException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.stopAtException(e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.started.set(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击initialize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (NamenodeRole.NAMENODE == role) &#123;</span><br><span class="line">	<span class="comment">// 启动HTTP服务端（9870）</span></span><br><span class="line">    startHttpServer(conf);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载镜像文件和编辑日志到内存</span></span><br><span class="line">  loadNamesystem(conf);</span><br><span class="line">  startAliasMapServerIfNecessary(conf);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建NN的RPC服务端</span></span><br><span class="line">  rpcServer = createRpcServer(conf);</span><br><span class="line"></span><br><span class="line">  initReconfigurableBackoffKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (clientNamenodeAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is expected for MiniDFSCluster. Set it now using </span></span><br><span class="line">    <span class="comment">// the RPC server's bind address.</span></span><br><span class="line">    clientNamenodeAddress = </span><br><span class="line">        NetUtils.getHostPortString(getNameNodeAddress());</span><br><span class="line">    LOG.info(<span class="string">"Clients are to use "</span> + clientNamenodeAddress + <span class="string">" to access"</span></span><br><span class="line">        + <span class="string">" this namenode/service."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (NamenodeRole.NAMENODE == role) &#123;</span><br><span class="line">    httpServer.setNameNodeAddress(getNameNodeAddress());</span><br><span class="line">    httpServer.setFSImage(getFSImage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// NN启动资源检查</span></span><br><span class="line">  startCommonServices(conf);</span><br><span class="line">  startMetricsLogger(conf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-启动9870端口服务"><a href="#1-1-启动9870端口服务" class="headerlink" title="1.1 启动9870端口服务"></a>1.1 启动9870端口服务</h2><p><strong>1）点击startHttpServer</strong></p>
<p>NameNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startHttpServer</span><span class="params">(<span class="keyword">final</span> Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	httpServer = <span class="keyword">new</span> NameNodeHttpServer(conf, <span class="keyword">this</span>, getHttpServerBindAddress(conf));</span><br><span class="line">	httpServer.start();</span><br><span class="line">	httpServer.setStartupProgress(startupProgress);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InetSocketAddress <span class="title">getHttpServerBindAddress</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  InetSocketAddress bindAddress = getHttpServerAddress(conf);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> bindAddress;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InetSocketAddress <span class="title">getHttpServerAddress</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getHttpAddress(conf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetSocketAddress <span class="title">getHttpAddress</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span>  NetUtils.createSocketAddr(</span><br><span class="line">      conf.getTrimmed(DFS_NAMENODE_HTTP_ADDRESS_KEY, DFS_NAMENODE_HTTP_ADDRESS_DEFAULT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String  DFS_NAMENODE_HTTP_ADDRESS_DEFAULT = <span class="string">"0.0.0.0:"</span> + DFS_NAMENODE_HTTP_PORT_DEFAULT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>     DFS_NAMENODE_HTTP_PORT_DEFAULT =</span><br><span class="line">HdfsClientConfigKeys.DFS_NAMENODE_HTTP_PORT_DEFAULT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>  DFS_NAMENODE_HTTP_PORT_DEFAULT = <span class="number">9870</span>;</span><br></pre></td></tr></table></figure>

<p><strong>2）点击startHttpServer方法中的httpServer.start();</strong></p>
<p>NameNodeHttpServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="comment">// Hadoop自己封装了HttpServer，形成自己的HttpServer2</span></span><br><span class="line">  HttpServer2.Builder builder = DFSUtil.httpServerTemplateForNNAndJN(conf,</span><br><span class="line">      httpAddr, httpsAddr, <span class="string">"hdfs"</span>,</span><br><span class="line">      DFSConfigKeys.DFS_NAMENODE_KERBEROS_INTERNAL_SPNEGO_PRINCIPAL_KEY,</span><br><span class="line">      DFSConfigKeys.DFS_NAMENODE_KEYTAB_FILE_KEY);</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  httpServer = builder.build();</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  httpServer.setAttribute(NAMENODE_ATTRIBUTE_KEY, nn);</span><br><span class="line">  httpServer.setAttribute(JspHelper.CURRENT_CONF, conf);</span><br><span class="line">  setupServlets(httpServer, conf);</span><br><span class="line">  httpServer.start();</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击setupServlets</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupServlets</span><span class="params">(HttpServer2 httpServer, Configuration conf)</span> </span>&#123;</span><br><span class="line">	httpServer.addInternalServlet(<span class="string">"startupProgress"</span>,</span><br><span class="line">		StartupProgressServlet.PATH_SPEC, StartupProgressServlet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	httpServer.addInternalServlet(<span class="string">"fsck"</span>, <span class="string">"/fsck"</span>, FsckServlet<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">true</span>)</span>;</span><br><span class="line">	httpServer.addInternalServlet(<span class="string">"imagetransfer"</span>, ImageServlet.PATH_SPEC,</span><br><span class="line">      ImageServlet<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-加载镜像文件和编辑日志"><a href="#1-2-加载镜像文件和编辑日志" class="headerlink" title="1.2 加载镜像文件和编辑日志"></a>1.2 加载镜像文件和编辑日志</h2><p><strong>1）点击loadNamesystem</strong></p>
<p>NameNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadNamesystem</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.namesystem = FSNamesystem.loadFromDisk(conf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FSNamesystem <span class="title">loadFromDisk</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  checkConfiguration(conf);</span><br><span class="line"></span><br><span class="line">  FSImage fsImage = <span class="keyword">new</span> FSImage(conf,</span><br><span class="line">      FSNamesystem.getNamespaceDirs(conf),</span><br><span class="line">      FSNamesystem.getNamespaceEditsDirs(conf));</span><br><span class="line"></span><br><span class="line">  FSNamesystem namesystem = <span class="keyword">new</span> FSNamesystem(conf, fsImage, <span class="keyword">false</span>);</span><br><span class="line">  StartupOption startOpt = NameNode.getStartupOption(conf);</span><br><span class="line">  <span class="keyword">if</span> (startOpt == StartupOption.RECOVER) &#123;</span><br><span class="line">    namesystem.setSafeMode(SafeModeAction.SAFEMODE_ENTER);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> loadStart = monotonicNow();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    namesystem.loadFSImage(startOpt);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    LOG.warn(<span class="string">"Encountered exception loading fsimage"</span>, ioe);</span><br><span class="line">    fsImage.close();</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span> timeTakenToLoadFSImage = monotonicNow() - loadStart;</span><br><span class="line">  LOG.info(<span class="string">"Finished loading FSImage in "</span> + timeTakenToLoadFSImage + <span class="string">" msecs"</span>);</span><br><span class="line">  NameNodeMetrics nnMetrics = NameNode.getNameNodeMetrics();</span><br><span class="line">  <span class="keyword">if</span> (nnMetrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">    nnMetrics.setFsImageLoadTime((<span class="keyword">int</span>) timeTakenToLoadFSImage);</span><br><span class="line">  &#125;</span><br><span class="line">  namesystem.getFSDirectory().createReservedStatuses(namesystem.getCTime());</span><br><span class="line">  <span class="keyword">return</span> namesystem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-初始化NN的RPC服务端"><a href="#1-3-初始化NN的RPC服务端" class="headerlink" title="1.3 初始化NN的RPC服务端"></a>1.3 初始化NN的RPC服务端</h2><p><strong>1）点击createRpcServer</strong></p>
<p>NameNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> NameNodeRpcServer <span class="title">createRpcServer</span><span class="params">(Configuration conf)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> NameNodeRpcServer(conf, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NameNodeRpcServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NameNodeRpcServer</span><span class="params">(Configuration conf, NameNode nn)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	... ....	</span><br><span class="line">    serviceRpcServer = <span class="keyword">new</span> RPC.Builder(conf)</span><br><span class="line">        .setProtocol(</span><br><span class="line">            org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolPB<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">setInstance</span>(<span class="title">clientNNPbService</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">setBindAddress</span>(<span class="title">bindHost</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">setPort</span>(<span class="title">serviceRpcAddr</span>.<span class="title">getPort</span>())</span></span><br><span class="line"><span class="class">        .<span class="title">setNumHandlers</span>(<span class="title">serviceHandlerCount</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">setVerbose</span>(<span class="title">false</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">setSecretManager</span>(<span class="title">namesystem</span>.<span class="title">getDelegationTokenSecretManager</span>())</span></span><br><span class="line"><span class="class">        .<span class="title">build</span>()</span>;</span><br><span class="line">	... ....	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-4-NN启动资源检查"><a href="#1-4-NN启动资源检查" class="headerlink" title="1.4 NN启动资源检查"></a>1.4 NN启动资源检查</h2><p><strong>1）点击startCommonServices</strong></p>
<p>NameNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCommonServices</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  namesystem.startCommonServices(conf, haContext);</span><br><span class="line"></span><br><span class="line">  registerNNSMXBean();</span><br><span class="line">  <span class="keyword">if</span> (NamenodeRole.NAMENODE != role) &#123;</span><br><span class="line">    startHttpServer(conf);</span><br><span class="line">    httpServer.setNameNodeAddress(getNameNodeAddress());</span><br><span class="line">    httpServer.setFSImage(getFSImage());</span><br><span class="line">  &#125;</span><br><span class="line">  rpcServer.start();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    plugins = conf.getInstances(DFS_NAMENODE_PLUGINS_KEY,</span><br><span class="line">        ServicePlugin<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    String pluginsValue = conf.get(DFS_NAMENODE_PLUGINS_KEY);</span><br><span class="line">    LOG.error(<span class="string">"Unable to load NameNode plugins. Specified list of plugins: "</span> +</span><br><span class="line">        pluginsValue, e);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  … …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）点击startCommonServices</strong></p>
<p>FSNamesystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startCommonServices</span><span class="params">(Configuration conf, HAContext haContext)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.registerMBean(); <span class="comment">// register the MBean for the FSNamesystemState</span></span><br><span class="line">  writeLock();</span><br><span class="line">  <span class="keyword">this</span>.haContext = haContext;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    nnResourceChecker = <span class="keyword">new</span> NameNodeResourceChecker(conf);</span><br><span class="line">    <span class="comment">// 检查是否有足够的磁盘存储元数据（fsimage（默认100m） editLog（默认100m））</span></span><br><span class="line">    checkAvailableResources();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> !blockManager.isPopulatingReplQueues();</span><br><span class="line">    StartupProgress prog = NameNode.getStartupProgress();</span><br><span class="line">    prog.beginPhase(Phase.SAFEMODE);</span><br><span class="line"><span class="keyword">long</span> completeBlocksTotal = getCompleteBlocksTotal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安全模式</span></span><br><span class="line">    prog.setTotal(Phase.SAFEMODE, STEP_AWAITING_REPORTED_BLOCKS,</span><br><span class="line">        completeBlocksTotal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动块服务</span></span><br><span class="line">    blockManager.activate(conf, completeBlocksTotal);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeUnlock(<span class="string">"startCommonServices"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  registerMXBean();</span><br><span class="line">  DefaultMetricsSystem.instance().register(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (inodeAttributeProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">    inodeAttributeProvider.start();</span><br><span class="line">    dir.setINodeAttributeProvider(inodeAttributeProvider);</span><br><span class="line">  &#125;</span><br><span class="line">  snapshotManager.registerMXBean();</span><br><span class="line">  InetSocketAddress serviceAddress = NameNode.getServiceAddress(conf, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">this</span>.nameNodeHostName = (serviceAddress != <span class="keyword">null</span>) ?</span><br><span class="line">      serviceAddress.getHostName() : <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击NameNodeResourceChecker</p>
<p>NameNodeResourceChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NameNodeResourceChecker</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.conf = conf;</span><br><span class="line">  volumes = <span class="keyword">new</span> HashMap&lt;String, CheckedVolume&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// dfs.namenode.resource.du.reserved默认值 1024 * 1024 * 100 =》100m</span></span><br><span class="line">  duReserved = conf.getLong(DFSConfigKeys.DFS_NAMENODE_DU_RESERVED_KEY,</span><br><span class="line">      DFSConfigKeys.DFS_NAMENODE_DU_RESERVED_DEFAULT);</span><br><span class="line">  </span><br><span class="line">  Collection&lt;URI&gt; extraCheckedVolumes = Util.stringCollectionAsURIs(conf</span><br><span class="line">      .getTrimmedStringCollection(DFSConfigKeys.DFS_NAMENODE_CHECKED_VOLUMES_KEY));</span><br><span class="line">  </span><br><span class="line">  Collection&lt;URI&gt; localEditDirs = Collections2.filter(</span><br><span class="line">      FSNamesystem.getNamespaceEditsDirs(conf),</span><br><span class="line">      <span class="keyword">new</span> Predicate&lt;URI&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(URI input)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (input.getScheme().equals(NNStorage.LOCAL_URI_SCHEME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对所有路径进行资源检查</span></span><br><span class="line">  <span class="keyword">for</span> (URI editsDirToCheck : localEditDirs) &#123;</span><br><span class="line">    addDirToCheck(editsDirToCheck,</span><br><span class="line">        FSNamesystem.getRequiredNamespaceEditsDirs(conf).contains(</span><br><span class="line">            editsDirToCheck));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// All extra checked volumes are marked "required"</span></span><br><span class="line">  <span class="keyword">for</span> (URI extraDirToCheck : extraCheckedVolumes) &#123;</span><br><span class="line">    addDirToCheck(extraDirToCheck, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  minimumRedundantVolumes = conf.getInt(</span><br><span class="line">      DFSConfigKeys.DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_KEY,</span><br><span class="line">      DFSConfigKeys.DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击checkAvailableResources</p>
<p>FNNamesystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkAvailableResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> resourceCheckTime = monotonicNow();</span><br><span class="line">	Preconditions.checkState(nnResourceChecker != <span class="keyword">null</span>,</span><br><span class="line">		<span class="string">"nnResourceChecker not initialized"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断资源是否足够，不够返回false</span></span><br><span class="line">	hasResourcesAvailable = nnResourceChecker.hasAvailableDiskSpace();</span><br><span class="line"></span><br><span class="line">	resourceCheckTime = monotonicNow() - resourceCheckTime;</span><br><span class="line">	NameNode.getNameNodeMetrics().addResourceCheckTime(resourceCheckTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NameNodeResourceChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasAvailableDiskSpace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> NameNodeResourcePolicy.areResourcesAvailable(volumes.values(),</span><br><span class="line">      minimumRedundantVolumes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NameNodeResourcePolicy.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">areResourcesAvailable</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Collection&lt;? extends CheckableNameNodeResource&gt; resources,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> minimumRedundantResources)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> workaround:</span></span><br><span class="line">  <span class="comment">// - during startup, if there are no edits dirs on disk, then there is</span></span><br><span class="line">  <span class="comment">// a call to areResourcesAvailable() with no dirs at all, which was</span></span><br><span class="line">  <span class="comment">// previously causing the NN to enter safemode</span></span><br><span class="line">  <span class="keyword">if</span> (resources.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> requiredResourceCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> redundantResourceCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> disabledRedundantResourceCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断资源是否充足</span></span><br><span class="line">  <span class="keyword">for</span> (CheckableNameNodeResource resource : resources) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!resource.isRequired()) &#123;</span><br><span class="line">      redundantResourceCount++;</span><br><span class="line">      <span class="keyword">if</span> (!resource.isResourceAvailable()) &#123;</span><br><span class="line">        disabledRedundantResourceCount++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      requiredResourceCount++;</span><br><span class="line">      <span class="keyword">if</span> (!resource.isResourceAvailable()) &#123;</span><br><span class="line">        <span class="comment">// Short circuit - a required resource is not available. 不充足返回false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (redundantResourceCount == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// If there are no redundant resources, return true if there are any</span></span><br><span class="line">    <span class="comment">// required resources available.</span></span><br><span class="line">    <span class="keyword">return</span> requiredResourceCount &gt; <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> redundantResourceCount - disabledRedundantResourceCount &gt;=</span><br><span class="line">        minimumRedundantResources;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CheckableNameNodeResource</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isResourceAvailable</span><span class="params">()</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRequired</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + h，查找实现类CheckedVolume</p>
<p>NameNodeResourceChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isResourceAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前目录的空间大小</span></span><br><span class="line">  <span class="keyword">long</span> availableSpace = df.getAvailable();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">"Space available on volume '"</span> + volume + <span class="string">"' is "</span></span><br><span class="line">        + availableSpace);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果当前空间大小，小于100m，返回false</span></span><br><span class="line">  <span class="keyword">if</span> (availableSpace &lt; duReserved) &#123;</span><br><span class="line">    LOG.warn(<span class="string">"Space available on volume '"</span> + volume + <span class="string">"' is "</span></span><br><span class="line">        + availableSpace +</span><br><span class="line">        <span class="string">", which is below the configured reserved amount "</span> + duReserved);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-NN对心跳超时判断"><a href="#1-5-NN对心跳超时判断" class="headerlink" title="1.5 NN对心跳超时判断"></a>1.5 NN对心跳超时判断</h2><p>Ctrl + n 搜索namenode，ctrl + f搜索startCommonServices</p>
<p>点击namesystem.startCommonServices(conf, haContext);</p>
<p>点击blockManager.activate(conf, completeBlocksTotal);</p>
<p>点击datanodeManager.activate(conf);</p>
<p>DatanodeManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activate</span><span class="params">(<span class="keyword">final</span> Configuration conf)</span> </span>&#123;</span><br><span class="line">  datanodeAdminManager.activate(conf);</span><br><span class="line">  heartbeatManager.activate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DatanodeManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 启动的线程，搜索run方法</span></span><br><span class="line">  heartbeatThread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(namesystem.isRunning()) &#123;</span><br><span class="line">    restartHeartbeatStopWatch();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> now = Time.monotonicNow();</span><br><span class="line">      <span class="keyword">if</span> (lastHeartbeatCheck + heartbeatRecheckInterval &lt; now) &#123;</span><br><span class="line">		<span class="comment">// 心跳检查</span></span><br><span class="line">        heartbeatCheck();</span><br><span class="line">        lastHeartbeatCheck = now;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (blockManager.shouldUpdateBlockKey(now - lastBlockKeyUpdate)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(HeartbeatManager.<span class="keyword">this</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span>(DatanodeDescriptor d : datanodes) &#123;</span><br><span class="line">            d.setNeedKeyUpdate(<span class="keyword">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lastBlockKeyUpdate = now;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOG.error(<span class="string">"Exception while checking heartbeat"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(<span class="number">5000</span>);  <span class="comment">// 5 seconds</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// avoid declaring nodes dead for another cycle if a GC pause lasts</span></span><br><span class="line">    <span class="comment">// longer than the node recheck interval</span></span><br><span class="line">    <span class="keyword">if</span> (shouldAbortHeartbeatCheck(-<span class="number">5000</span>)) &#123;</span><br><span class="line">      LOG.warn(<span class="string">"Skipping next heartbeat scan due to excessive pause"</span>);</span><br><span class="line">      lastHeartbeatCheck = Time.monotonicNow();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heartbeatCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> DatanodeManager dm = blockManager.getDatanodeManager();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> allAlive = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (!allAlive) &#123;</span><br><span class="line">    <span class="comment">// locate the first dead node.</span></span><br><span class="line">    DatanodeDescriptor dead = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locate the first failed storage that isn't on a dead node.</span></span><br><span class="line">    DatanodeStorageInfo failedStorage = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check the number of stale nodes</span></span><br><span class="line">    <span class="keyword">int</span> numOfStaleNodes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numOfStaleStorages = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (DatanodeDescriptor d : datanodes) &#123;</span><br><span class="line">        <span class="comment">// check if an excessive GC pause has occurred</span></span><br><span class="line">        <span class="keyword">if</span> (shouldAbortHeartbeatCheck(<span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 判断DN节点是否挂断</span></span><br><span class="line">        <span class="keyword">if</span> (dead == <span class="keyword">null</span> &amp;&amp; dm.isDatanodeDead(d)) &#123;</span><br><span class="line">          stats.incrExpiredHeartbeats();</span><br><span class="line">          dead = d;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (d.isStale(dm.getStaleInterval())) &#123;</span><br><span class="line">          numOfStaleNodes++;</span><br><span class="line">        &#125;</span><br><span class="line">        DatanodeStorageInfo[] storageInfos = d.getStorageInfos();</span><br><span class="line">        <span class="keyword">for</span>(DatanodeStorageInfo storageInfo : storageInfos) &#123;</span><br><span class="line">          <span class="keyword">if</span> (storageInfo.areBlockContentsStale()) &#123;</span><br><span class="line">            numOfStaleStorages++;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (failedStorage == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">              storageInfo.areBlocksOnFailedStorage() &amp;&amp;</span><br><span class="line">              d != dead) &#123;</span><br><span class="line">            failedStorage = storageInfo;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Set the number of stale nodes in the DatanodeManager</span></span><br><span class="line">      dm.setNumStaleNodes(numOfStaleNodes);</span><br><span class="line">      dm.setNumStaleStorages(numOfStaleStorages);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDatanodeDead</span><span class="params">(DatanodeDescriptor node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (node.getLastUpdateMonotonic() &lt;</span><br><span class="line">          (monotonicNow() - heartbeatExpireInterval));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> heartbeatExpireInterval;</span><br><span class="line"><span class="comment">// 10分钟 + 30秒</span></span><br><span class="line"><span class="keyword">this</span>.heartbeatExpireInterval = <span class="number">2</span> * heartbeatRecheckInterval + <span class="number">10</span> * <span class="number">1000</span> * heartbeatIntervalSeconds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> heartbeatRecheckInterval;</span><br><span class="line">heartbeatRecheckInterval = conf.getInt(</span><br><span class="line">        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_KEY, </span><br><span class="line">        DFSConfigKeys.DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_DEFAULT); <span class="comment">// 5 minutes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> heartbeatIntervalSeconds;</span><br><span class="line">heartbeatIntervalSeconds = conf.getTimeDuration(</span><br><span class="line">        DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,</span><br><span class="line">        DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_DEFAULT, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span>    DFS_HEARTBEAT_INTERVAL_DEFAULT = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h2 id="1-6-安全模式"><a href="#1-6-安全模式" class="headerlink" title="1.6 安全模式"></a>1.6 安全模式</h2><p>FSNamesystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startCommonServices</span><span class="params">(Configuration conf, HAContext haContext)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.registerMBean(); <span class="comment">// register the MBean for the FSNamesystemState</span></span><br><span class="line">  writeLock();</span><br><span class="line">  <span class="keyword">this</span>.haContext = haContext;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    nnResourceChecker = <span class="keyword">new</span> NameNodeResourceChecker(conf);</span><br><span class="line">    <span class="comment">// 检查是否有足够的磁盘存储元数据（fsimage（默认100m） editLog（默认100m））</span></span><br><span class="line">    checkAvailableResources();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> !blockManager.isPopulatingReplQueues();</span><br><span class="line">    StartupProgress prog = NameNode.getStartupProgress();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始进入安全模式</span></span><br><span class="line">    prog.beginPhase(Phase.SAFEMODE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取所有可以正常使用的block</span></span><br><span class="line"><span class="keyword">long</span> completeBlocksTotal = getCompleteBlocksTotal();</span><br><span class="line"></span><br><span class="line">    prog.setTotal(Phase.SAFEMODE, STEP_AWAITING_REPORTED_BLOCKS,</span><br><span class="line">        completeBlocksTotal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动块服务</span></span><br><span class="line">    blockManager.activate(conf, completeBlocksTotal);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeUnlock(<span class="string">"startCommonServices"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  registerMXBean();</span><br><span class="line">  DefaultMetricsSystem.instance().register(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (inodeAttributeProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">    inodeAttributeProvider.start();</span><br><span class="line">    dir.setINodeAttributeProvider(inodeAttributeProvider);</span><br><span class="line">  &#125;</span><br><span class="line">  snapshotManager.registerMXBean();</span><br><span class="line">  InetSocketAddress serviceAddress = NameNode.getServiceAddress(conf, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">this</span>.nameNodeHostName = (serviceAddress != <span class="keyword">null</span>) ?</span><br><span class="line">      serviceAddress.getHostName() : <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击getCompleteBlocksTotal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCompleteBlocksTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Calculate number of blocks under construction</span></span><br><span class="line">  <span class="keyword">long</span> numUCBlocks = <span class="number">0</span>;</span><br><span class="line">  readLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取正在构建的block</span></span><br><span class="line">    numUCBlocks = leaseManager.getNumUnderConstructionBlocks();</span><br><span class="line">	<span class="comment">// 获取所有的块 - 正在构建的block = 可以正常使用的block</span></span><br><span class="line">    <span class="keyword">return</span> getBlocksTotal() - numUCBlocks;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readUnlock(<span class="string">"getCompleteBlocksTotal"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击activate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">(Configuration conf, <span class="keyword">long</span> blockTotal)</span> </span>&#123;</span><br><span class="line">	pendingReconstruction.start();</span><br><span class="line">	datanodeManager.activate(conf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.redundancyThread.setName(<span class="string">"RedundancyMonitor"</span>);</span><br><span class="line">	<span class="keyword">this</span>.redundancyThread.start();</span><br><span class="line"></span><br><span class="line">	storageInfoDefragmenterThread.setName(<span class="string">"StorageInfoMonitor"</span>);</span><br><span class="line">	storageInfoDefragmenterThread.start();</span><br><span class="line">	<span class="keyword">this</span>.blockReportThread.start();</span><br><span class="line"></span><br><span class="line">	mxBeanName = MBeans.register(<span class="string">"NameNode"</span>, <span class="string">"BlockStats"</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	bmSafeMode.activate(blockTotal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击activate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activate</span><span class="params">(<span class="keyword">long</span> total)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  <span class="keyword">assert</span> status == BMSafeModeStatus.OFF;</span><br><span class="line"></span><br><span class="line">  startTime = monotonicNow();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算是否满足块个数的阈值</span></span><br><span class="line">  setBlockTotal(total);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断DataNode节点和块信息是否达到退出安全模式标准</span></span><br><span class="line">  <span class="keyword">if</span> (areThresholdsMet()) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> exitResult = leaveSafeMode(<span class="keyword">false</span>);</span><br><span class="line">    Preconditions.checkState(exitResult, <span class="string">"Failed to leave safe mode."</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// enter safe mode</span></span><br><span class="line">status = BMSafeModeStatus.PENDING_THRESHOLD;</span><br><span class="line"></span><br><span class="line">initializeReplQueuesIfNecessary();</span><br><span class="line"></span><br><span class="line">    reportStatus(<span class="string">"STATE* Safe mode ON."</span>, <span class="keyword">true</span>);</span><br><span class="line">    lastStatusReport = monotonicNow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击setBlockTotal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setBlockTotal</span><span class="params">(<span class="keyword">long</span> total)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.blockTotal = total;</span><br><span class="line">	<span class="comment">// 计算阈值：例如：1000个正常的块 * 0.999 = 999</span></span><br><span class="line">    <span class="keyword">this</span>.blockThreshold = (<span class="keyword">long</span>) (total * threshold);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.blockReplQueueThreshold = (<span class="keyword">long</span>) (total * replQueueThreshold);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.threshold = conf.getFloat(DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY,</span><br><span class="line">        DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span>   DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT = <span class="number">0.999f</span>;</span><br></pre></td></tr></table></figure>

<p>点击areThresholdsMet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">areThresholdsMet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  <span class="comment">// Calculating the number of live datanodes is time-consuming</span></span><br><span class="line">  <span class="comment">// in large clusters. Skip it when datanodeThreshold is zero.</span></span><br><span class="line">  <span class="keyword">int</span> datanodeNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (datanodeThreshold &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    datanodeNum = blockManager.getDatanodeManager().getNumLiveDataNodes();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">  <span class="comment">// 已经正常注册的块数 》= 块的最小阈值 》=最小可用DataNode</span></span><br><span class="line">    <span class="keyword">return</span> blockSafe &gt;= blockThreshold &amp;&amp; datanodeNum &gt;= datanodeThreshold;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第2章-DataNode启动源码解析"><a href="#第2章-DataNode启动源码解析" class="headerlink" title="第2章 DataNode启动源码解析"></a>第2章 DataNode启动源码解析</h1><p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808164121857.png" alt="image-20220808164121857"></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808164153531.png" alt="image-20220808164153531"></p>
<p><strong>0）在pom.xml中增加如下依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>1）ctrl + n 全局查找datanode，进入DataNode.java</strong></p>
<p>​    DataNode官方说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DataNode is a <span class="title">class</span> <span class="params">(and program)</span> that stores a set of blocks <span class="keyword">for</span> a DFS deployment. A single deployment can have one or many DataNodes. Each DataNode communicates regularly with a single NameNode. It also communicates with client code and other DataNodes from time to time. DataNodes store a series of named blocks. The DataNode allows client code to read these blocks, or to write new block data. The DataNode may also, in response to instructions from its NameNode, delete blocks or copy blocks to/from other DataNodes. The DataNode maintains just one critical table: block-&gt; stream of <span class="title">bytes</span> <span class="params">(of BLOCK_SIZE or less)</span> This info is stored on a local disk. The DataNode reports the table's contents to the NameNode upon startup and every so often afterwards. DataNodes spend their lives in an endless loop of asking the NameNode <span class="keyword">for</span> something to <span class="keyword">do</span>. A NameNode cannot connect to a DataNode directly</span>; a NameNode simply returns values from functions invoked by a DataNode. DataNodes maintain an open server socket so that client code or other DataNodes can read/write data. The host/port <span class="keyword">for</span> <span class="keyword">this</span> server is reported to the NameNode, which then sends that information to clients or other DataNodes that might be interested.</span><br></pre></td></tr></table></figure>

<p><strong>2）ctrl + f，查找main方法</strong></p>
<p>DataNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (DFSUtil.parseHelpArgument(args, DataNode.USAGE, System.out, <span class="keyword">true</span>)) &#123;</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  secureMain(args, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">secureMain</span><span class="params">(String args[], SecureResources resources)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> errorCode = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    StringUtils.startupShutdownMessage(DataNode<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>, <span class="title">LOG</span>)</span>;</span><br><span class="line"></span><br><span class="line">    DataNode datanode = createDataNode(args, <span class="keyword">null</span>, resources);</span><br><span class="line"></span><br><span class="line">    … …</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Exception in secureMain"</span>, e);</span><br><span class="line">    terminate(<span class="number">1</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    LOG.warn(<span class="string">"Exiting Datanode"</span>);</span><br><span class="line">    terminate(errorCode);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataNode <span class="title">createDataNode</span><span class="params">(String args[], Configuration conf,</span></span></span><br><span class="line"><span class="function"><span class="params">    SecureResources resources)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化DN</span></span><br><span class="line">  DataNode dn = instantiateDataNode(args, conf, resources);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dn != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 启动DN进程</span></span><br><span class="line">    dn.runDatanodeDaemon();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataNode <span class="title">instantiateDataNode</span><span class="params">(String args [], Configuration conf,</span></span></span><br><span class="line"><span class="function"><span class="params">    SecureResources resources)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> makeInstance(dataLocations, conf, resources);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> DataNode <span class="title">makeInstance</span><span class="params">(Collection&lt;StorageLocation&gt; dataDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">    Configuration conf, SecureResources resources)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DataNode(conf, locations, storageLocationChecker, resources);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataNode(<span class="keyword">final</span> Configuration conf,</span><br><span class="line">         <span class="keyword">final</span> List&lt;StorageLocation&gt; dataDirs,</span><br><span class="line">         <span class="keyword">final</span> StorageLocationChecker storageLocationChecker,</span><br><span class="line">         <span class="keyword">final</span> SecureResources resources) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">super</span>(conf);</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    hostName = getHostName(conf);</span><br><span class="line">    LOG.info(<span class="string">"Configured hostname is &#123;&#125;"</span>, hostName);</span><br><span class="line">	<span class="comment">// 启动DN</span></span><br><span class="line">    startDataNode(dataDirs, resources);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">    shutdown();</span><br><span class="line">    <span class="keyword">throw</span> ie;</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startDataNode</span><span class="params">(List&lt;StorageLocation&gt; dataDirectories,</span></span></span><br><span class="line"><span class="function"><span class="params">                   SecureResources resources</span></span></span><br><span class="line"><span class="function"><span class="params">                   )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="comment">// 创建数据存储对象</span></span><br><span class="line">  storage = <span class="keyword">new</span> DataStorage();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// global DN settings</span></span><br><span class="line">  registerMXBean();</span><br><span class="line">  <span class="comment">// 初始化DataXceiver</span></span><br><span class="line">  initDataXceiver();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 启动HttpServer</span></span><br><span class="line">  startInfoServer();</span><br><span class="line"></span><br><span class="line">  pauseMonitor = <span class="keyword">new</span> JvmPauseMonitor();</span><br><span class="line">  pauseMonitor.init(getConf());</span><br><span class="line">  pauseMonitor.start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BlockPoolTokenSecretManager is required to create ipc server.</span></span><br><span class="line">  <span class="keyword">this</span>.blockPoolTokenSecretManager = <span class="keyword">new</span> BlockPoolTokenSecretManager();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Login is done by now. Set the DN user name.</span></span><br><span class="line">  dnUserName = UserGroupInformation.getCurrentUser().getUserName();</span><br><span class="line">  LOG.info(<span class="string">"dnUserName = &#123;&#125;"</span>, dnUserName);</span><br><span class="line">  LOG.info(<span class="string">"supergroup = &#123;&#125;"</span>, supergroup);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 初始化RPC服务</span></span><br><span class="line">  initIpcServer();</span><br><span class="line"></span><br><span class="line">  metrics = DataNodeMetrics.create(getConf(), getDisplayName());</span><br><span class="line">  peerMetrics = dnConf.peerStatsEnabled ?</span><br><span class="line">      DataNodePeerMetrics.create(getDisplayName(), getConf()) : <span class="keyword">null</span>;</span><br><span class="line">  metrics.getJvmMetrics().setPauseMonitor(pauseMonitor);</span><br><span class="line"></span><br><span class="line">  ecWorker = <span class="keyword">new</span> ErasureCodingWorker(getConf(), <span class="keyword">this</span>);</span><br><span class="line">  blockRecoveryWorker = <span class="keyword">new</span> BlockRecoveryWorker(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建BlockPoolManager</span></span><br><span class="line">  blockPoolManager = <span class="keyword">new</span> BlockPoolManager(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// 心跳管理</span></span><br><span class="line">  blockPoolManager.refreshNamenodes(getConf());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the ReadaheadPool from the DataNode context so we can</span></span><br><span class="line">  <span class="comment">// exit without having to explicitly shutdown its thread pool.</span></span><br><span class="line">  readaheadPool = ReadaheadPool.getInstance();</span><br><span class="line">  saslClient = <span class="keyword">new</span> SaslDataTransferClient(dnConf.getConf(),</span><br><span class="line">      dnConf.saslPropsResolver, dnConf.trustedChannelResolver);</span><br><span class="line">  saslServer = <span class="keyword">new</span> SaslDataTransferServer(dnConf, blockPoolTokenSecretManager);</span><br><span class="line">  startMetricsLogger();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dnConf.diskStatsEnabled) &#123;</span><br><span class="line">    diskMetrics = <span class="keyword">new</span> DataNodeDiskMetrics(<span class="keyword">this</span>,</span><br><span class="line">        dnConf.outliersReportIntervalMs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-1-初始化DataXceiverServer"><a href="#2-1-初始化DataXceiverServer" class="headerlink" title="2.1 初始化DataXceiverServer"></a>2.1 初始化DataXceiverServer</h2><p>点击initDataXceiver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDataXceiver</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">// dataXceiverServer是一个服务，DN用来接收客户端和其他DN发送过来的数据服务</span></span><br><span class="line">  <span class="keyword">this</span>.dataXceiverServer = <span class="keyword">new</span> Daemon(threadGroup, xserver);</span><br><span class="line">  <span class="keyword">this</span>.threadGroup.setDaemon(<span class="keyword">true</span>); <span class="comment">// auto destroy when empty</span></span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-初始化HTTP服务"><a href="#2-2-初始化HTTP服务" class="headerlink" title="2.2 初始化HTTP服务"></a>2.2 初始化HTTP服务</h2><p>点击startInfoServer();</p>
<p>DataNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInfoServer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// SecureDataNodeStarter will bind the privileged port to the channel if</span></span><br><span class="line">  <span class="comment">// the DN is started by JSVC, pass it along.</span></span><br><span class="line">  ServerSocketChannel httpServerChannel = secureResources != <span class="keyword">null</span> ?</span><br><span class="line">      secureResources.getHttpServerChannel() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  httpServer = <span class="keyword">new</span> DatanodeHttpServer(getConf(), <span class="keyword">this</span>, httpServerChannel);</span><br><span class="line">  httpServer.start();</span><br><span class="line">  <span class="keyword">if</span> (httpServer.getHttpAddress() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    infoPort = httpServer.getHttpAddress().getPort();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (httpServer.getHttpsAddress() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    infoSecurePort = httpServer.getHttpsAddress().getPort();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DatanodeHttpServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DatanodeHttpServer</span><span class="params">(<span class="keyword">final</span> Configuration conf,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> DataNode datanode,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> ServerSocketChannel externalHttpChannel)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  ... ...</span><br><span class="line">  HttpServer2.Builder builder = <span class="keyword">new</span> HttpServer2.Builder()</span><br><span class="line">      .setName(<span class="string">"datanode"</span>)</span><br><span class="line">      .setConf(confForInfoServer)</span><br><span class="line">      .setACL(<span class="keyword">new</span> AccessControlList(conf.get(DFS_ADMIN, <span class="string">" "</span>)))</span><br><span class="line">      .hostName(getHostnameForSpnegoPrincipal(confForInfoServer))</span><br><span class="line">      .addEndpoint(URI.create(<span class="string">"http://localhost:"</span> + proxyPort))</span><br><span class="line">      .setFindPort(<span class="keyword">true</span>);</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-初始化DN的RPC服务端"><a href="#2-3-初始化DN的RPC服务端" class="headerlink" title="2.3 初始化DN的RPC服务端"></a>2.3 初始化DN的RPC服务端</h2><p>点击initIpcServer</p>
<p>DataNode.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initIpcServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  InetSocketAddress ipcAddr = NetUtils.createSocketAddr(</span><br><span class="line">      getConf().getTrimmed(DFS_DATANODE_IPC_ADDRESS_KEY));</span><br><span class="line">  </span><br><span class="line">  ... ...</span><br><span class="line">  ipcServer = <span class="keyword">new</span> RPC.Builder(getConf())</span><br><span class="line">      .setProtocol(ClientDatanodeProtocolPB<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">setInstance</span>(<span class="title">service</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">setBindAddress</span>(<span class="title">ipcAddr</span>.<span class="title">getHostName</span>())</span></span><br><span class="line"><span class="class">      .<span class="title">setPort</span>(<span class="title">ipcAddr</span>.<span class="title">getPort</span>())</span></span><br><span class="line"><span class="class">      .<span class="title">setNumHandlers</span>(</span></span><br><span class="line"><span class="class">          <span class="title">getConf</span>().<span class="title">getInt</span>(<span class="title">DFS_DATANODE_HANDLER_COUNT_KEY</span>,</span></span><br><span class="line"><span class="class">              <span class="title">DFS_DATANODE_HANDLER_COUNT_DEFAULT</span>)).<span class="title">setVerbose</span>(<span class="title">false</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">setSecretManager</span>(<span class="title">blockPoolTokenSecretManager</span>).<span class="title">build</span>()</span>;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-DN向NN注册"><a href="#2-4-DN向NN注册" class="headerlink" title="2.4 DN向NN注册"></a>2.4 DN向NN注册</h2><p>点击refreshNamenodes</p>
<p>BlockPoolManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">refreshNamenodes</span><span class="params">(Configuration conf)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (refreshNamenodesLock) &#123;</span><br><span class="line">    doRefreshNamenodes(newAddressMap, newLifelineAddressMap);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRefreshNamenodes</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;String, Map&lt;String, InetSocketAddress&gt;&gt; addrMap,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;String, Map&lt;String, InetSocketAddress&gt;&gt; lifelineAddrMap)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  … ….</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    … …</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3. Start new nameservices</span></span><br><span class="line">    <span class="keyword">if</span> (!toAdd.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (String nsToAdd : toAdd) &#123;</span><br><span class="line">        … …</span><br><span class="line">        BPOfferService bpos = createBPOS(nsToAdd, addrs, lifelineAddrs);</span><br><span class="line">        bpByNameserviceId.put(nsToAdd, bpos);</span><br><span class="line">        offerServices.add(bpos);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    startAll();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  … …</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> BPOfferService <span class="title">createBPOS</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String nameserviceId,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;InetSocketAddress&gt; nnAddrs,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;InetSocketAddress&gt; lifelineNnAddrs)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 根据NameNode个数创建对应的服务</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> BPOfferService(nameserviceId, nnAddrs, lifelineNnAddrs, dn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击startAll()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    UserGroupInformation.getLoginUser().doAs(</span><br><span class="line">        <span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (BPOfferService bpos : offerServices) &#123;</span><br><span class="line">			  <span class="comment">// 启动服务</span></span><br><span class="line">              bpos.start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击start ()</p>
<p>BPOfferService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (BPServiceActor actor : bpServices) &#123;</span><br><span class="line">    actor.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击start ()</p>
<p>BPServiceActor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  bpThread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</span><br><span class="line">  bpThread.setDaemon(<span class="keyword">true</span>); <span class="comment">// needed for JUnit testing</span></span><br><span class="line"><span class="comment">// 表示开启一个线程，所有查找该线程的run方法</span></span><br><span class="line">  bpThread.start();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lifelineSender != <span class="keyword">null</span>) &#123;</span><br><span class="line">    lifelineSender.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + f 搜索run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="keyword">this</span> + <span class="string">" starting to offer service"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="comment">// init stuff</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// setup storage</span></span><br><span class="line">		<span class="comment">// 向NN 注册</span></span><br><span class="line">        connectToNNAndHandshake();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// Initial handshake, storage recovery or registration failed</span></span><br><span class="line">        runningState = RunningState.INIT_FAILED;</span><br><span class="line">        <span class="keyword">if</span> (shouldRetryInit()) &#123;</span><br><span class="line">          <span class="comment">// Retry until all namenode's of BPOS failed initialization</span></span><br><span class="line">          LOG.error(<span class="string">"Initialization failed for "</span> + <span class="keyword">this</span> + <span class="string">" "</span></span><br><span class="line">              + ioe.getLocalizedMessage());</span><br><span class="line">		  <span class="comment">// 注册失败，5s后重试</span></span><br><span class="line">          sleepAndLogInterrupts(<span class="number">5000</span>, <span class="string">"initializing"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          runningState = RunningState.FAILED;</span><br><span class="line">          LOG.error(<span class="string">"Initialization failed for "</span> + <span class="keyword">this</span> + <span class="string">". Exiting. "</span>, ioe);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    … …</span><br><span class="line">    <span class="keyword">while</span> (shouldRun()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发送心跳</span></span><br><span class="line">        offerService();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectToNNAndHandshake</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// get NN proxy 获取NN的RPC客户端对象</span></span><br><span class="line">  bpNamenode = dn.connectToNN(nnAddr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First phase of the handshake with NN - get the namespace</span></span><br><span class="line">  <span class="comment">// info.</span></span><br><span class="line">  NamespaceInfo nsInfo = retrieveNamespaceInfo();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Verify that this matches the other NN in this HA pair.</span></span><br><span class="line">  <span class="comment">// This also initializes our block pool in the DN if we are</span></span><br><span class="line">  <span class="comment">// the first NN connection for this BP.</span></span><br><span class="line">  bpos.verifyAndSetNamespaceInfo(<span class="keyword">this</span>, nsInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* set thread name again to include NamespaceInfo when it's available. */</span></span><br><span class="line">  <span class="keyword">this</span>.bpThread.setName(formatThreadName(<span class="string">"heartbeating"</span>, nnAddr));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册</span></span><br><span class="line">  register(nsInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DatanodeProtocolClientSideTranslatorPB <span class="title">connectToNN</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    InetSocketAddress nnAddr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DatanodeProtocolClientSideTranslatorPB(nnAddr, getConf());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DatanodeProtocolClientSideTranslatorPB.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DatanodeProtocolClientSideTranslatorPB</span><span class="params">(InetSocketAddress nameNodeAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">    Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  RPC.setProtocolEngine(conf, DatanodeProtocolPB<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">ProtobufRpcEngine</span>.<span class="title">class</span>)</span>;</span><br><span class="line">  UserGroupInformation ugi = UserGroupInformation.getCurrentUser();</span><br><span class="line">  rpcProxy = createNamenode(nameNodeAddr, conf, ugi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DatanodeProtocolPB <span class="title">createNamenode</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    InetSocketAddress nameNodeAddr, Configuration conf,</span></span></span><br><span class="line"><span class="function"><span class="params">    UserGroupInformation ugi)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> RPC.getProxy(DatanodeProtocolPB<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">RPC</span>.<span class="title">getProtocolVersion</span>(<span class="title">DatanodeProtocolPB</span>.<span class="title">class</span>), <span class="title">nameNodeAddr</span>, <span class="title">ugi</span>,</span></span><br><span class="line"><span class="class">      <span class="title">conf</span>, <span class="title">NetUtils</span>.<span class="title">getSocketFactory</span>(<span class="title">conf</span>, <span class="title">DatanodeProtocolPB</span>.<span class="title">class</span>))</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击register</p>
<p>BPServiceActor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(NamespaceInfo nsInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 创建注册信息</span></span><br><span class="line">  DatanodeRegistration newBpRegistration = bpos.createRegistration();</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="keyword">this</span> + <span class="string">" beginning handshake with NN"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (shouldRun()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Use returned registration from namenode with updated fields</span></span><br><span class="line">	  <span class="comment">// 把注册信息发送给NN（DN调用接口方法，执行在NN）</span></span><br><span class="line">      newBpRegistration = bpNamenode.registerDatanode(newBpRegistration);</span><br><span class="line">      newBpRegistration.setNamespaceInfo(nsInfo);</span><br><span class="line">      bpRegistration = newBpRegistration;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(EOFException e) &#123;  <span class="comment">// namenode might have just restarted</span></span><br><span class="line">      LOG.info(<span class="string">"Problem connecting to server: "</span> + nnAddr + <span class="string">" :"</span></span><br><span class="line">          + e.getLocalizedMessage());</span><br><span class="line">      sleepAndLogInterrupts(<span class="number">1000</span>, <span class="string">"connecting to server"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(SocketTimeoutException e) &#123;  <span class="comment">// namenode is busy</span></span><br><span class="line">      LOG.info(<span class="string">"Problem connecting to server: "</span> + nnAddr);</span><br><span class="line">      sleepAndLogInterrupts(<span class="number">1000</span>, <span class="string">"connecting to server"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  … …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + n 搜索NameNodeRpcServer</p>
<p>NameNodeRpcServer.java</p>
<p>ctrl + f 在NameNodeRpcServer.java中搜索registerDatanode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DatanodeRegistration <span class="title">registerDatanode</span><span class="params">(DatanodeRegistration nodeReg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  checkNNStartup();</span><br><span class="line">  verifySoftwareVersion(nodeReg);</span><br><span class="line">  <span class="comment">// 注册DN</span></span><br><span class="line">  namesystem.registerDatanode(nodeReg);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> nodeReg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FSNamesystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerDatanode</span><span class="params">(DatanodeRegistration nodeReg)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    blockManager.registerDatanode(nodeReg);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeUnlock(<span class="string">"registerDatanode"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDatanode</span><span class="params">(DatanodeRegistration nodeReg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  datanodeManager.registerDatanode(nodeReg);</span><br><span class="line">  bmSafeMode.checkSafeMode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDatanode</span><span class="params">(DatanodeRegistration nodeReg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> DisallowedDatanodeException, UnresolvedTopologyException </span>&#123;</span><br><span class="line">	... ...</span><br><span class="line">	<span class="comment">// register new datanode 注册DN</span></span><br><span class="line">    addDatanode(nodeDescr);</span><br><span class="line">    blockManager.getBlockReportLeaseManager().register(nodeDescr);</span><br><span class="line">    <span class="comment">// also treat the registration message as a heartbeat</span></span><br><span class="line">    <span class="comment">// no need to update its timestamp</span></span><br><span class="line">    <span class="comment">// because its is done when the descriptor is created</span></span><br><span class="line">	<span class="comment">// 将DN添加到心跳管理</span></span><br><span class="line">    heartbeatManager.addDatanode(nodeDescr);</span><br><span class="line">    heartbeatManager.updateDnStat(nodeDescr);</span><br><span class="line">    incrementVersionCount(nodeReg.getSoftwareVersion());</span><br><span class="line">    startAdminOperationIfNecessary(nodeDescr);</span><br><span class="line">    success = <span class="keyword">true</span>;</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addDatanode</span><span class="params">(<span class="keyword">final</span> DatanodeDescriptor node)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// To keep host2DatanodeMap consistent with datanodeMap,</span></span><br><span class="line">  <span class="comment">// remove  from host2DatanodeMap the datanodeDescriptor removed</span></span><br><span class="line">  <span class="comment">// from datanodeMap before adding node to host2DatanodeMap.</span></span><br><span class="line">  <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">    host2DatanodeMap.remove(datanodeMap.put(node.getDatanodeUuid(), node));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  networktopology.add(node); <span class="comment">// may throw InvalidTopologyException</span></span><br><span class="line">  host2DatanodeMap.add(node);</span><br><span class="line">  checkIfClusterIsNowMultiRack(node);</span><br><span class="line">  resolveUpgradeDomain(node);</span><br><span class="line"></span><br><span class="line">  … …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-向NN发送心跳"><a href="#2-5-向NN发送心跳" class="headerlink" title="2.5 向NN发送心跳"></a>2.5 向NN发送心跳</h2><p>点击BPServiceActor.java中的run方法中的offerService方法</p>
<p>BPServiceActor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">offerService</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (shouldRun()) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        HeartbeatResponse resp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (sendHeartbeat) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">boolean</span> requestBlockReportLease = (fullBlockReportLeaseId == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">                  scheduler.isBlockReportDue(startTime);</span><br><span class="line">          <span class="keyword">if</span> (!dn.areHeartbeatsDisabledForTests()) &#123;</span><br><span class="line">		    <span class="comment">// 发送心跳信息</span></span><br><span class="line">            resp = sendHeartBeat(requestBlockReportLease);</span><br><span class="line">            <span class="keyword">assert</span> resp != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (resp.getFullBlockReportLeaseId() != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (fullBlockReportLeaseId != <span class="number">0</span>) &#123;</span><br><span class="line">				... ...</span><br><span class="line">              &#125;</span><br><span class="line">              fullBlockReportLeaseId = resp.getFullBlockReportLeaseId();</span><br><span class="line">            &#125;</span><br><span class="line">            ... ...</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		... ...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HeartbeatResponse <span class="title">sendHeartBeat</span><span class="params">(<span class="keyword">boolean</span> requestBlockReportLease)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	... ...</span><br><span class="line">	<span class="comment">// 通过NN的RPC客户端发送给NN</span></span><br><span class="line">	HeartbeatResponse response = bpNamenode.sendHeartbeat(bpRegistration,</span><br><span class="line">        reports,</span><br><span class="line">        dn.getFSDataset().getCacheCapacity(),</span><br><span class="line">        dn.getFSDataset().getCacheUsed(),</span><br><span class="line">        dn.getXmitsInProgress(),</span><br><span class="line">        dn.getXceiverCount(),</span><br><span class="line">        numFailedVolumes,</span><br><span class="line">        volumeFailureSummary,</span><br><span class="line">        requestBlockReportLease,</span><br><span class="line">        slowPeers,</span><br><span class="line">        slowDisks);</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + n 搜索NameNodeRpcServer</p>
<p>NameNodeRpcServer.java</p>
<p>ctrl + f 在NameNodeRpcServer.java中搜索sendHeartbeat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HeartbeatResponse <span class="title">sendHeartbeat</span><span class="params">(DatanodeRegistration nodeReg,</span></span></span><br><span class="line"><span class="function"><span class="params">    StorageReport[] report, <span class="keyword">long</span> dnCacheCapacity, <span class="keyword">long</span> dnCacheUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> xmitsInProgress, <span class="keyword">int</span> xceiverCount,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> failedVolumes, VolumeFailureSummary volumeFailureSummary,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> requestFullBlockReportLease,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nonnull SlowPeerReports slowPeers,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nonnull SlowDiskReports slowDisks)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  checkNNStartup();</span><br><span class="line">  verifyRequest(nodeReg);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理DN发送的心跳</span></span><br><span class="line">  <span class="keyword">return</span> namesystem.handleHeartbeat(nodeReg, report,</span><br><span class="line">      dnCacheCapacity, dnCacheUsed, xceiverCount, xmitsInProgress,</span><br><span class="line">      failedVolumes, volumeFailureSummary, requestFullBlockReportLease,</span><br><span class="line">      slowPeers, slowDisks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HeartbeatResponse <span class="title">handleHeartbeat</span><span class="params">(DatanodeRegistration nodeReg,</span></span></span><br><span class="line"><span class="function"><span class="params">    StorageReport[] reports, <span class="keyword">long</span> cacheCapacity, <span class="keyword">long</span> cacheUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> xmitsInProgress, <span class="keyword">int</span> failedVolumes,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> requestFullBlockReportLease,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nonnull SlowPeerReports slowPeers,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nonnull SlowDiskReports slowDisks)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  readLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//get datanode commands</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxTransfer = blockManager.getMaxReplicationStreams()</span><br><span class="line">        - xmitsInProgress;</span><br><span class="line">	<span class="comment">// 处理DN发送过来的心跳</span></span><br><span class="line">    DatanodeCommand[] cmds = blockManager.getDatanodeManager().handleHeartbeat(</span><br><span class="line">        nodeReg, reports, getBlockPoolId(), cacheCapacity, cacheUsed,</span><br><span class="line">        xceiverCount, maxTransfer, failedVolumes, volumeFailureSummary,</span><br><span class="line">        slowPeers, slowDisks);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> blockReportLeaseId = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (requestFullBlockReportLease) &#123;</span><br><span class="line">      blockReportLeaseId =  blockManager.requestBlockReportLeaseId(nodeReg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//create ha status</span></span><br><span class="line">    <span class="keyword">final</span> NNHAStatusHeartbeat haState = <span class="keyword">new</span> NNHAStatusHeartbeat(</span><br><span class="line">        haContext.getState().getServiceState(),</span><br><span class="line">        getFSImage().getCorrectLastAppliedOrWrittenTxId());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 响应DN的心跳</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HeartbeatResponse(cmds, haState, rollingUpgradeInfo,</span><br><span class="line">        blockReportLeaseId);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readUnlock(<span class="string">"handleHeartbeat"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击handleHeartbeat</p>
<p>DatanodeManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DatanodeCommand[] handleHeartbeat(DatanodeRegistration nodeReg,</span><br><span class="line">    StorageReport[] reports, <span class="keyword">final</span> String blockPoolId,</span><br><span class="line">    <span class="keyword">long</span> cacheCapacity, <span class="keyword">long</span> cacheUsed, <span class="keyword">int</span> xceiverCount, </span><br><span class="line">    <span class="keyword">int</span> maxTransfers, <span class="keyword">int</span> failedVolumes,</span><br><span class="line">    VolumeFailureSummary volumeFailureSummary,</span><br><span class="line">    <span class="meta">@Nonnull</span> SlowPeerReports slowPeers,</span><br><span class="line">    <span class="meta">@Nonnull</span> SlowDiskReports slowDisks) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  heartbeatManager.updateHeartbeat(nodeinfo, reports, cacheCapacity,</span><br><span class="line">      cacheUsed, xceiverCount, failedVolumes, volumeFailureSummary);</span><br><span class="line">  ... ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HeartbeatManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateHeartbeat</span><span class="params">(<span class="keyword">final</span> DatanodeDescriptor node,</span></span></span><br><span class="line"><span class="function"><span class="params">    StorageReport[] reports, <span class="keyword">long</span> cacheCapacity, <span class="keyword">long</span> cacheUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> failedVolumes,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary)</span> </span>&#123;</span><br><span class="line">  stats.subtract(node);</span><br><span class="line">  blockManager.updateHeartbeat(node, reports, cacheCapacity, cacheUsed,</span><br><span class="line">      xceiverCount, failedVolumes, volumeFailureSummary);</span><br><span class="line">  stats.add(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateHeartbeat</span><span class="params">(DatanodeDescriptor node, StorageReport[] reports,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> cacheCapacity, <span class="keyword">long</span> cacheUsed, <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> failedVolumes,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (StorageReport report: reports) &#123;</span><br><span class="line">    providedStorageMap.updateStorage(node, report.getStorage());</span><br><span class="line">  &#125;</span><br><span class="line">  node.updateHeartbeat(reports, cacheCapacity, cacheUsed, xceiverCount,</span><br><span class="line">      failedVolumes, volumeFailureSummary);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DatanodeDescriptor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateHeartbeat</span><span class="params">(StorageReport[] reports, <span class="keyword">long</span> cacheCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> cacheUsed, <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> volFailures,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary)</span> </span>&#123;</span><br><span class="line">  updateHeartbeatState(reports, cacheCapacity, cacheUsed, xceiverCount,</span><br><span class="line">      volFailures, volumeFailureSummary);</span><br><span class="line">  heartbeatedSinceRegistration = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateHeartbeatState</span><span class="params">(StorageReport[] reports, <span class="keyword">long</span> cacheCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> cacheUsed, <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> volFailures,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 更新存储</span></span><br><span class="line">  updateStorageStats(reports, cacheCapacity, cacheUsed, xceiverCount,</span><br><span class="line">      volFailures, volumeFailureSummary);</span><br><span class="line">  <span class="comment">// 更新心跳时间</span></span><br><span class="line">  setLastUpdate(Time.now());</span><br><span class="line">  setLastUpdateMonotonic(Time.monotonicNow());</span><br><span class="line">  rollBlocksScheduled(getLastUpdateMonotonic());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateStorageStats</span><span class="params">(StorageReport[] reports, <span class="keyword">long</span> cacheCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> cacheUsed, <span class="keyword">int</span> xceiverCount, <span class="keyword">int</span> volFailures,</span></span></span><br><span class="line"><span class="function"><span class="params">    VolumeFailureSummary volumeFailureSummary)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> totalCapacity = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> totalRemaining = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> totalBlockPoolUsed = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> totalDfsUsed = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> totalNonDfsUsed = <span class="number">0</span>;</span><br><span class="line">  … …</span><br><span class="line"></span><br><span class="line">  setCacheCapacity(cacheCapacity);</span><br><span class="line">  setCacheUsed(cacheUsed);</span><br><span class="line">  setXceiverCount(xceiverCount);</span><br><span class="line">  <span class="keyword">this</span>.volumeFailures = volFailures;</span><br><span class="line">  <span class="keyword">this</span>.volumeFailureSummary = volumeFailureSummary;</span><br><span class="line">  <span class="keyword">for</span> (StorageReport report : reports) &#123;</span><br><span class="line"></span><br><span class="line">    DatanodeStorageInfo storage =</span><br><span class="line">        storageMap.get(report.getStorage().getStorageID());</span><br><span class="line">    <span class="keyword">if</span> (checkFailedStorages) &#123;</span><br><span class="line">      failedStorageInfos.remove(storage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    storage.receivedHeartbeat(report);</span><br><span class="line">    <span class="comment">// skip accounting for capacity of PROVIDED storages!</span></span><br><span class="line">    <span class="keyword">if</span> (StorageType.PROVIDED.equals(storage.getStorageType())) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    totalCapacity += report.getCapacity();</span><br><span class="line">    totalRemaining += report.getRemaining();</span><br><span class="line">    totalBlockPoolUsed += report.getBlockPoolUsed();</span><br><span class="line">    totalDfsUsed += report.getDfsUsed();</span><br><span class="line">    totalNonDfsUsed += report.getNonDfsUsed();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update total metrics for the node.</span></span><br><span class="line">  <span class="comment">// 更新存储相关信息</span></span><br><span class="line">  setCapacity(totalCapacity);</span><br><span class="line">  setRemaining(totalRemaining);</span><br><span class="line">  setBlockPoolUsed(totalBlockPoolUsed);</span><br><span class="line">  setDfsUsed(totalDfsUsed);</span><br><span class="line">  setNonDfsUsed(totalNonDfsUsed);</span><br><span class="line">  <span class="keyword">if</span> (checkFailedStorages) &#123;</span><br><span class="line">    updateFailedStorage(failedStorageInfos);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span> storageMapSize;</span><br><span class="line">  <span class="keyword">synchronized</span> (storageMap) &#123;</span><br><span class="line">    storageMapSize = storageMap.size();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (storageMapSize != reports.length) &#123;</span><br><span class="line">    pruneStorageMap(reports);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第3章-HDFS上传源码解析"><a href="#第3章-HDFS上传源码解析" class="headerlink" title="第3章 HDFS上传源码解析"></a>第3章 HDFS上传源码解析</h1><p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808165138080.png" alt="image-20220808165138080"></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808165240958.png" alt="image-20220808165240958"></p>
<h2 id="3-1-create创建过程"><a href="#3-1-create创建过程" class="headerlink" title="3.1 create创建过程"></a>3.1 create创建过程</h2><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-1-DN向NN发起创建请求"><a href="#3-1-1-DN向NN发起创建请求" class="headerlink" title="3.1.1 DN向NN发起创建请求"></a>3.1.1 DN向NN发起创建请求</h3><p>用户自己写的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPut2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	FSDataOutputStream fos = fs.create(<span class="keyword">new</span> Path(<span class="string">"/input"</span>));</span><br><span class="line"></span><br><span class="line">	fos.write(<span class="string">"hello world"</span>.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FileSystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> create(f, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f, <span class="keyword">boolean</span> overwrite)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> create(f, overwrite,</span><br><span class="line">			  getConf().getInt(IO_FILE_BUFFER_SIZE_KEY,</span><br><span class="line">				  IO_FILE_BUFFER_SIZE_DEFAULT),</span><br><span class="line">			  getDefaultReplication(f),</span><br><span class="line">			  getDefaultBlockSize(f));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">boolean</span> overwrite,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> bufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">long</span> blockSize)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> create(f, overwrite, bufferSize, replication, blockSize, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">boolean</span> overwrite,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> bufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	Progressable progress</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">										</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.create(f, FsCreateModes.applyUMask(</span><br><span class="line">	FsPermission.getFileDefault(), FsPermission.getUMask(getConf())),</span><br><span class="line">	overwrite, bufferSize, replication, blockSize, progress);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f,</span></span></span><br><span class="line"><span class="function"><span class="params">	FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">boolean</span> overwrite,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> bufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	Progressable progress)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>

<p>选中create，点击ctrl+h，找到实现类DistributedFileSystem.java，查找create方法。</p>
<p>DistributedFileSystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f, FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">boolean</span> overwrite, <span class="keyword">int</span> bufferSize, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  Progressable progress)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.create(f, permission,</span><br><span class="line">	overwrite ? EnumSet.of(CreateFlag.CREATE, CreateFlag.OVERWRITE)</span><br><span class="line">		: EnumSet.of(CreateFlag.CREATE), bufferSize, replication,</span><br><span class="line">	blockSize, progress, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(<span class="keyword">final</span> Path f, <span class="keyword">final</span> FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> EnumSet&lt;CreateFlag&gt; cflags, <span class="keyword">final</span> <span class="keyword">int</span> bufferSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> <span class="keyword">short</span> replication, <span class="keyword">final</span> <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">final</span> Progressable progress, <span class="keyword">final</span> ChecksumOpt checksumOpt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	statistics.incrementWriteOps(<span class="number">1</span>);</span><br><span class="line">	storageStatistics.incrementOpCounter(OpType.CREATE);</span><br><span class="line">	Path absF = fixRelativePart(f);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> FileSystemLinkResolver&lt;FSDataOutputStream&gt;() &#123;</span><br><span class="line"></span><br><span class="line">	  <span class="meta">@Override</span></span><br><span class="line">	  <span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">doCall</span><span class="params">(<span class="keyword">final</span> Path p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建获取了一个输出流对象</span></span><br><span class="line">		<span class="keyword">final</span> DFSOutputStream dfsos = dfs.create(getPathName(p), permission,</span><br><span class="line">			cflags, replication, blockSize, progress, bufferSize,</span><br><span class="line">			checksumOpt);</span><br><span class="line">		<span class="comment">// 这里将上面创建的dfsos进行包装并返回</span></span><br><span class="line">		<span class="keyword">return</span> dfs.createWrappedOutputStream(dfsos, statistics);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="meta">@Override</span></span><br><span class="line">	  <span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">next</span><span class="params">(<span class="keyword">final</span> FileSystem fs, <span class="keyword">final</span> Path p)</span></span></span><br><span class="line"><span class="function">		  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> fs.create(p, permission, cflags, bufferSize,</span><br><span class="line">			replication, blockSize, progress, checksumOpt);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;.resolve(<span class="keyword">this</span>, absF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击create，进入DFSClient.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DFSOutputStream <span class="title">create</span><span class="params">(String src, FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">  EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  Progressable progress, <span class="keyword">int</span> buffersize, ChecksumOpt checksumOpt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> create(src, permission, flag, <span class="keyword">true</span>,</span><br><span class="line">	replication, blockSize, progress, buffersize, checksumOpt, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DFSOutputStream <span class="title">create</span><span class="params">(String src, FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">  EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">long</span> blockSize, Progressable progress, <span class="keyword">int</span> buffersize,</span></span></span><br><span class="line"><span class="function"><span class="params">  ChecksumOpt checksumOpt, InetSocketAddress[] favoredNodes)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> create(src, permission, flag, createParent, replication, blockSize,</span><br><span class="line">	progress, buffersize, checksumOpt, favoredNodes, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DFSOutputStream <span class="title">create</span><span class="params">(String src, FsPermission permission,</span></span></span><br><span class="line"><span class="function"><span class="params">  EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">long</span> blockSize, Progressable progress, <span class="keyword">int</span> buffersize,</span></span></span><br><span class="line"><span class="function"><span class="params">  ChecksumOpt checksumOpt, InetSocketAddress[] favoredNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">  String ecPolicyName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	checkOpen();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">final</span> FsPermission masked = applyUMask(permission);</span><br><span class="line">	LOG.debug(<span class="string">"&#123;&#125;: masked=&#123;&#125;"</span>, src, masked);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">final</span> DFSOutputStream result = DFSOutputStream.newStreamForCreate(<span class="keyword">this</span>,</span><br><span class="line">		src, masked, flag, createParent, replication, blockSize, progress,</span><br><span class="line">		dfsClientConf.createChecksum(checksumOpt),</span><br><span class="line">		getFavoredNodesStr(favoredNodes), ecPolicyName);</span><br><span class="line">		</span><br><span class="line">	beginFileLease(result.getFileId(), result);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击newStreamForCreate，进入DFSOutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> DFSOutputStream <span class="title">newStreamForCreate</span><span class="params">(DFSClient dfsClient, String src,</span></span></span><br><span class="line"><span class="function"><span class="params">  FsPermission masked, EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize, Progressable progress,</span></span></span><br><span class="line"><span class="function"><span class="params">  DataChecksum checksum, String[] favoredNodes, String ecPolicyName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">try</span> (TraceScope ignored =</span><br><span class="line">			 dfsClient.newPathTraceScope(<span class="string">"newStreamForCreate"</span>, src)) &#123;</span><br><span class="line">	  HdfsFileStatus stat = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Retry the create if we get a RetryStartFileException up to a maximum</span></span><br><span class="line">	  <span class="comment">// number of times</span></span><br><span class="line">	  <span class="keyword">boolean</span> shouldRetry = <span class="keyword">true</span>;</span><br><span class="line">	  <span class="keyword">int</span> retryCount = CREATE_RETRY_COUNT;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">while</span> (shouldRetry) &#123;</span><br><span class="line">		shouldRetry = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		  <span class="comment">// DN将创建请求发送给NN（RPC）</span></span><br><span class="line">		  stat = dfsClient.namenode.create(src, masked, dfsClient.clientName,</span><br><span class="line">			  <span class="keyword">new</span> EnumSetWritable&lt;&gt;(flag), createParent, replication,</span><br><span class="line">			  blockSize, SUPPORTED_CRYPTO_VERSIONS, ecPolicyName);</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">		  … ….</span><br><span class="line">		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  Preconditions.checkNotNull(stat, <span class="string">"HdfsFileStatus should not be null!"</span>);</span><br><span class="line">	  <span class="keyword">final</span> DFSOutputStream out;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span>(stat.getErasureCodingPolicy() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		out = <span class="keyword">new</span> DFSStripedOutputStream(dfsClient, src, stat,</span><br><span class="line">			flag, progress, checksum, favoredNodes);</span><br><span class="line">	  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		out = <span class="keyword">new</span> DFSOutputStream(dfsClient, src, stat,</span><br><span class="line">			flag, progress, checksum, favoredNodes, <span class="keyword">true</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// 开启线程run，DataStreamer extends Daemon extends Thread</span></span><br><span class="line">	  out.start();</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">return</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-NN处理DN的创建请求"><a href="#3-1-2-NN处理DN的创建请求" class="headerlink" title="3.1.2 NN处理DN的创建请求"></a>3.1.2 NN处理DN的创建请求</h3><p><strong>1）点击create</strong></p>
<p>ClientProtocol.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HdfsFileStatus <span class="title">create</span><span class="params">(String src, FsPermission masked,</span></span></span><br><span class="line"><span class="function"><span class="params">    String clientName, EnumSetWritable&lt;CreateFlag&gt; flag,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    CryptoProtocolVersion[] supportedVersions, String ecPolicyName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>

<p><strong>2）Ctrl + h查找create实现类，点击NameNodeRpcServer，在NameNodeRpcServer.java中搜索create</strong></p>
<p>NameNodeRpcServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HdfsFileStatus <span class="title">create</span><span class="params">(String src, FsPermission masked,</span></span></span><br><span class="line"><span class="function"><span class="params">    String clientName, EnumSetWritable&lt;CreateFlag&gt; flag,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    CryptoProtocolVersion[] supportedVersions, String ecPolicyName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 检查NN启动</span></span><br><span class="line">  checkNNStartup();</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  HdfsFileStatus status = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    PermissionStatus perm = <span class="keyword">new</span> PermissionStatus(getRemoteUser()</span><br><span class="line">        .getShortUserName(), <span class="keyword">null</span>, masked);</span><br><span class="line">	<span class="comment">// 重要</span></span><br><span class="line">    status = namesystem.startFile(src, perm, clientName, clientMachine,</span><br><span class="line">        flag.get(), createParent, replication, blockSize, supportedVersions,</span><br><span class="line">        ecPolicyName, cacheEntry != <span class="keyword">null</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    RetryCache.setState(cacheEntry, status != <span class="keyword">null</span>, status);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  metrics.incrFilesCreated();</span><br><span class="line">  metrics.incrCreateFileOps();</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FSNamesystem.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HdfsFileStatus <span class="title">startFile</span><span class="params">(String src, PermissionStatus permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">    String holder, String clientMachine, EnumSet&lt;CreateFlag&gt; flag,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    CryptoProtocolVersion[] supportedVersions, String ecPolicyName,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> logRetryCache)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  HdfsFileStatus status;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    status = startFileInt(src, permissions, holder, clientMachine, flag,</span><br><span class="line">        createParent, replication, blockSize, supportedVersions, ecPolicyName,</span><br><span class="line">        logRetryCache);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (AccessControlException e) &#123;</span><br><span class="line">    logAuditEvent(<span class="keyword">false</span>, <span class="string">"create"</span>, src);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  logAuditEvent(<span class="keyword">true</span>, <span class="string">"create"</span>, src, status);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> HdfsFileStatus <span class="title">startFileInt</span><span class="params">(String src,</span></span></span><br><span class="line"><span class="function"><span class="params">    PermissionStatus permissions, String holder, String clientMachine,</span></span></span><br><span class="line"><span class="function"><span class="params">    EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> blockSize, CryptoProtocolVersion[] supportedVersions,</span></span></span><br><span class="line"><span class="function"><span class="params">    String ecPolicyName, <span class="keyword">boolean</span> logRetryCache)</span> <span class="keyword">throws</span> IOException </span>&#123;       </span><br><span class="line">	... ...</span><br><span class="line">	stat = FSDirWriteFileOp.startFile(<span class="keyword">this</span>, iip, permissions, holder,</span><br><span class="line">        clientMachine, flag, createParent, replication, blockSize, feInfo,</span><br><span class="line">        toRemoveBlocks, shouldReplicate, ecPolicyName, logRetryCache);</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> HdfsFileStatus <span class="title">startFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ... ...)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	</span><br><span class="line">  ... ...</span><br><span class="line">  FSDirectory fsd = fsn.getFSDirectory();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件路径是否存在校验</span></span><br><span class="line">  <span class="keyword">if</span> (iip.getLastINode() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (overwrite) &#123;</span><br><span class="line">      List&lt;INode&gt; toRemoveINodes = <span class="keyword">new</span> ChunkedArrayList&lt;&gt;();</span><br><span class="line">      List&lt;Long&gt; toRemoveUCFiles = <span class="keyword">new</span> ChunkedArrayList&lt;&gt;();</span><br><span class="line">      <span class="keyword">long</span> ret = FSDirDeleteOp.delete(fsd, iip, toRemoveBlocks,</span><br><span class="line">                                      toRemoveINodes, toRemoveUCFiles, now());</span><br><span class="line">      <span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        iip = INodesInPath.replace(iip, iip.length() - <span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">        FSDirDeleteOp.incrDeletedFileCount(ret);</span><br><span class="line">        fsn.removeLeasesAndINodes(toRemoveUCFiles, toRemoveINodes, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If lease soft limit time is expired, recover the lease</span></span><br><span class="line">      fsn.recoverLeaseInternal(FSNamesystem.RecoverLeaseOp.CREATE_FILE, iip,</span><br><span class="line">                               src, holder, clientMachine, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FileAlreadyExistsException(src + <span class="string">" for client "</span> +</span><br><span class="line">          clientMachine + <span class="string">" already exists"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fsn.checkFsObjectLimit();</span><br><span class="line">  INodeFile newNode = <span class="keyword">null</span>;</span><br><span class="line">  INodesInPath parent = FSDirMkdirOp.createAncestorDirectories(fsd, iip, permissions);</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加文件元数据信息</span></span><br><span class="line">    iip = addFile(fsd, parent, iip.getLastLocalName(), permissions,</span><br><span class="line">        replication, blockSize, holder, clientMachine, shouldReplicate,</span><br><span class="line">        ecPolicyName);</span><br><span class="line">    newNode = iip != <span class="keyword">null</span> ? iip.getLastINode().asFile() : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  setNewINodeStoragePolicy(fsd.getBlockManager(), iip, isLazyPersist);</span><br><span class="line">  fsd.getEditLog().logOpenFile(src, newNode, overwrite, logRetryEntry);</span><br><span class="line">  <span class="keyword">if</span> (NameNode.stateChangeLog.isDebugEnabled()) &#123;</span><br><span class="line">    NameNode.stateChangeLog.debug(<span class="string">"DIR* NameSystem.startFile: added "</span> +</span><br><span class="line">        src + <span class="string">" inode "</span> + newNode.getId() + <span class="string">" "</span> + holder);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> FSDirStatAndListingOp.getFileInfo(fsd, iip, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> INodesInPath <span class="title">addFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    FSDirectory fsd, INodesInPath existing, <span class="keyword">byte</span>[] localName,</span></span></span><br><span class="line"><span class="function"><span class="params">    PermissionStatus permissions, <span class="keyword">short</span> replication, <span class="keyword">long</span> preferredBlockSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    String clientName, String clientMachine, <span class="keyword">boolean</span> shouldReplicate,</span></span></span><br><span class="line"><span class="function"><span class="params">    String ecPolicyName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  Preconditions.checkNotNull(existing);</span><br><span class="line">  <span class="keyword">long</span> modTime = now();</span><br><span class="line">  INodesInPath newiip;</span><br><span class="line">  fsd.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    … …</span><br><span class="line"></span><br><span class="line">    newiip = fsd.addINode(existing, newNode, permissions.getPermission());</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    fsd.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> newiip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INodesInPath <span class="title">addINode</span><span class="params">(INodesInPath existing, INode child,</span></span></span><br><span class="line"><span class="function"><span class="params">                      FsPermission modes)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> QuotaExceededException, UnresolvedLinkException </span>&#123;</span><br><span class="line">  cacheName(child);</span><br><span class="line">  writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 将数据写入到INode的目录树中</span></span><br><span class="line">    <span class="keyword">return</span> addLastINode(existing, child, modes, <span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-DataStreamer启动流程"><a href="#3-1-3-DataStreamer启动流程" class="headerlink" title="3.1.3 DataStreamer启动流程"></a>3.1.3 DataStreamer启动流程</h3><p>NN处理完DN请求后，再次回到DN端，启动对应的线程</p>
<p>DFSOutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> DFSOutputStream <span class="title">newStreamForCreate</span><span class="params">(DFSClient dfsClient, String src,</span></span></span><br><span class="line"><span class="function"><span class="params">  FsPermission masked, EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize, Progressable progress,</span></span></span><br><span class="line"><span class="function"><span class="params">  DataChecksum checksum, String[] favoredNodes, String ecPolicyName)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	... ...</span><br><span class="line">	<span class="comment">// DN将创建请求发送给NN（RPC）</span></span><br><span class="line">	stat = dfsClient.namenode.create(src, masked, dfsClient.clientName,</span><br><span class="line">	  <span class="keyword">new</span> EnumSetWritable&lt;&gt;(flag), createParent, replication,</span><br><span class="line">	  blockSize, SUPPORTED_CRYPTO_VERSIONS, ecPolicyName);</span><br><span class="line">	... ...</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建输出流</span></span><br><span class="line">	out = <span class="keyword">new</span> DFSOutputStream(dfsClient, src, stat,</span><br><span class="line">            flag, progress, checksum, favoredNodes, <span class="keyword">true</span>);</span><br><span class="line">	<span class="comment">// 开启线程run，DataStreamer extends Daemon extends Thread</span></span><br><span class="line">	out.start();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击DFSOutputStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">DFSOutputStream</span><span class="params">(DFSClient dfsClient, String src,</span></span></span><br><span class="line"><span class="function"><span class="params">    HdfsFileStatus stat, EnumSet&lt;CreateFlag&gt; flag, Progressable progress,</span></span></span><br><span class="line"><span class="function"><span class="params">    DataChecksum checksum, String[] favoredNodes, <span class="keyword">boolean</span> createStreamer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(dfsClient, src, flag, progress, stat, checksum);</span><br><span class="line">  <span class="keyword">this</span>.shouldSyncBlock = flag.contains(CreateFlag.SYNC_BLOCK);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Directory =&gt; File =&gt; Block(128M) =&gt; packet(64K) =&gt; chunk（chunk 512byte + chunksum 4byte）</span></span><br><span class="line">  computePacketChunkSize(dfsClient.getConf().getWritePacketSize(),</span><br><span class="line">      bytesPerChecksum);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (createStreamer) &#123;</span><br><span class="line">    streamer = <span class="keyword">new</span> DataStreamer(stat, <span class="keyword">null</span>, dfsClient, src, progress,</span><br><span class="line">        checksum, cachingStrategy, byteArrayManager, favoredNodes,</span><br><span class="line">        addBlockFlags);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>1）点击newStreamForCreate方法中的out.start()，进入DFSOutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	getStreamer().start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> DataStreamer <span class="title">getStreamer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> streamer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击DataStreamer，进入DataStreamer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataStreamer</span> <span class="keyword">extends</span> <span class="title">Daemon</span> </span>&#123;</span><br><span class="line">    。。。 。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击Daemon，进入Daemon.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Daemon</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    。。。 。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：out.start();实际是开启线程，点击DataStreamer，搜索run方法</p>
<p>DataStreamer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">long</span> lastPacket = Time.monotonicNow();</span><br><span class="line">	TraceScope scope = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">while</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">	  <span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line">	  <span class="keyword">if</span> (errorState.hasError()) &#123;</span><br><span class="line">		closeResponder();</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  DFSPacket one;</span><br><span class="line">	  <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// process datanode IO errors if any</span></span><br><span class="line">		<span class="keyword">boolean</span> doSleep = processDatanodeOrExternalError();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> halfSocketTimeout = dfsClient.getConf().getSocketTimeout()/<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">		  <span class="comment">// wait for a packet to be sent.</span></span><br><span class="line">		  … …</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			  <span class="comment">// 如果dataQueue里面没有数据，代码会阻塞在这儿</span></span><br><span class="line">			  dataQueue.wait(timeout);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">			  LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			doSleep = <span class="keyword">false</span>;</span><br><span class="line">			now = Time.monotonicNow();</span><br><span class="line">		  &#125;</span><br><span class="line">		  … …</span><br><span class="line">			<span class="comment">//  队列不为空，从队列中取出packet</span></span><br><span class="line">			one = dataQueue.getFirst(); <span class="comment">// regular data packet</span></span><br><span class="line">			SpanId[] parents = one.getTraceParents();</span><br><span class="line">			<span class="keyword">if</span> (parents.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			  scope = dfsClient.getTracer().</span><br><span class="line">				  newScope(<span class="string">"dataStreamer"</span>, parents[<span class="number">0</span>]);</span><br><span class="line">			  scope.getSpan().setParents(parents);</span><br><span class="line">			&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		… …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-write上传过程"><a href="#3-2-write上传过程" class="headerlink" title="3.2 write上传过程"></a>3.2 write上传过程</h2><h3 id="3-1-1-向DataStreamer的队列里面写数据"><a href="#3-1-1-向DataStreamer的队列里面写数据" class="headerlink" title="3.1.1 向DataStreamer的队列里面写数据"></a>3.1.1 向DataStreamer的队列里面写数据</h3><p><strong>1）用户写的代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPut2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FSDataOutputStream fos = fs.create(<span class="keyword">new</span> Path(<span class="string">"/input"</span>));</span><br><span class="line"></span><br><span class="line">    fos.write(<span class="string">"hello world"</span>.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）点击write</strong></p>
<p>FilterOutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[])</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    write(b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((off | len | (b.length - (len + off)) | (off + len)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; len ; i++) &#123;</span><br><span class="line">        write(b[off + i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    out.write(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）点击write</strong></p>
<p>OutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>

<p>ctrl + h 查找write实现类，选择FSOutputSummer.java，在该类中查找write</p>
<p>FSOutputSummer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  buf[count++] = (<span class="keyword">byte</span>)b;</span><br><span class="line">  <span class="keyword">if</span>(count == buf.length) &#123;</span><br><span class="line">    flushBuffer();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  flushBuffer(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">flushBuffer</span><span class="params">(<span class="keyword">boolean</span> keep,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> flushPartial)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> bufLen = count;</span><br><span class="line">  <span class="keyword">int</span> partialLen = bufLen % sum.getBytesPerChecksum();</span><br><span class="line">  <span class="keyword">int</span> lenToFlush = flushPartial ? bufLen : bufLen - partialLen;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lenToFlush != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 向队列中写数据   </span></span><br><span class="line"><span class="comment">// Directory =&gt; File =&gt; Block(128M) =&gt; package(64K) =&gt; chunk（chunk 512byte + chunksum 4byte）</span></span><br><span class="line">writeChecksumChunks(buf, <span class="number">0</span>, lenToFlush);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!flushPartial || keep) &#123;</span><br><span class="line">      count = partialLen;</span><br><span class="line">      System.arraycopy(buf, bufLen - count, buf, <span class="number">0</span>, count);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// total bytes left minus unflushed bytes left</span></span><br><span class="line">  <span class="keyword">return</span> count - (bufLen - lenToFlush);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeChecksumChunks</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算chunk的校验和</span></span><br><span class="line">  sum.calculateChunkedSums(b, off, len, checksum, <span class="number">0</span>);</span><br><span class="line">  TraceScope scope = createWriteTraceScope();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按照chunk的大小遍历数据</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i += sum.getBytesPerChecksum()) &#123;</span><br><span class="line">      <span class="keyword">int</span> chunkLen = Math.min(sum.getBytesPerChecksum(), len - i);</span><br><span class="line">      <span class="keyword">int</span> ckOffset = i / sum.getBytesPerChecksum() * getChecksumSize();</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// 一个chunk一个chunk的将数据写入队列</span></span><br><span class="line">      writeChunk(b, off + i, chunkLen, checksum, ckOffset,</span><br><span class="line">          getChecksumSize());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">      scope.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">writeChunk</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> bOffset, <span class="keyword">int</span> bLen,</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="keyword">byte</span>[] checksum, <span class="keyword">int</span> checksumOffset, <span class="keyword">int</span> checksumLen)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>

<p>ctrl + h 查找writeChunk实现类DFSOutputStream.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">writeChunk</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> offset, <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">byte</span>[] checksum, <span class="keyword">int</span> ckoff, <span class="keyword">int</span> cklen)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  writeChunkPrepare(len, ckoff, cklen);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 往packet里面写chunk的校验和 4byte</span></span><br><span class="line">  currentPacket.writeChecksum(checksum, ckoff, cklen);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 往packet里面写一个chunk 512 byte</span></span><br><span class="line">  currentPacket.writeData(b, offset, len);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录写入packet中的chunk个数，累计到127个chuck，这个packet就满了</span></span><br><span class="line">  currentPacket.incNumChunks();</span><br><span class="line">  getStreamer().incBytesCurBlock(len);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If packet is full, enqueue it for transmission</span></span><br><span class="line">  <span class="keyword">if</span> (currentPacket.getNumChunks() == currentPacket.getMaxChunks() ||</span><br><span class="line">      getStreamer().getBytesCurBlock() == blockSize) &#123;</span><br><span class="line">    enqueueCurrentPacketFull();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueueCurrentPacketFull</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  LOG.debug(<span class="string">"enqueue full &#123;&#125;, src=&#123;&#125;, bytesCurBlock=&#123;&#125;, blockSize=&#123;&#125;,"</span></span><br><span class="line">          + <span class="string">" appendChunk=&#123;&#125;, &#123;&#125;"</span>, currentPacket, src, getStreamer()</span><br><span class="line">          .getBytesCurBlock(), blockSize, getStreamer().getAppendChunk(),</span><br><span class="line">      getStreamer());</span><br><span class="line"></span><br><span class="line">  enqueueCurrentPacket();</span><br><span class="line"></span><br><span class="line">  adjustChunkBoundary();</span><br><span class="line"></span><br><span class="line">  endBlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueCurrentPacket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  getStreamer().waitAndQueuePacket(currentPacket);</span><br><span class="line">  currentPacket = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitAndQueuePacket</span><span class="params">(DFSPacket packet)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 如果队列满了，等待</span></span><br><span class="line">      <span class="comment">// If queue is full, then wait till we have enough space</span></span><br><span class="line">      <span class="keyword">boolean</span> firstWait = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!streamerClosed &amp;&amp; dataQueue.size() + ackQueue.size() &gt;</span><br><span class="line">            dfsClient.getConf().getWriteMaxPackets()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (firstWait) &#123;</span><br><span class="line">            Span span = Tracer.getCurrentSpan();</span><br><span class="line">            <span class="keyword">if</span> (span != <span class="keyword">null</span>) &#123;</span><br><span class="line">              span.addTimelineAnnotation(<span class="string">"dataQueue.wait"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            firstWait = <span class="keyword">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            dataQueue.wait();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            ... ...</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Span span = Tracer.getCurrentSpan();</span><br><span class="line">        <span class="keyword">if</span> ((span != <span class="keyword">null</span>) &amp;&amp; (!firstWait)) &#123;</span><br><span class="line">          span.addTimelineAnnotation(<span class="string">"end.wait"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      checkClosed();</span><br><span class="line">	  <span class="comment">// 如果队列没满，向队列中添加数据</span></span><br><span class="line">      queuePacket(packet);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClosedChannelException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataStreamer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">queuePacket</span><span class="params">(DFSPacket packet)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (packet == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    packet.addTraceParent(Tracer.getCurrentSpanId());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向队列中添加数据</span></span><br><span class="line">    dataQueue.addLast(packet);</span><br><span class="line"></span><br><span class="line">    lastQueuedSeqno = packet.getSeqno();</span><br><span class="line">    LOG.debug(<span class="string">"Queued &#123;&#125;, &#123;&#125;"</span>, packet, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通知队列添加数据完成</span></span><br><span class="line">    dataQueue.notifyAll();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-建立管道之机架感知（块存储位置）"><a href="#3-1-2-建立管道之机架感知（块存储位置）" class="headerlink" title="3.1.2 建立管道之机架感知（块存储位置）"></a>3.1.2 建立管道之机架感知（块存储位置）</h3><p>Ctrl + n全局查找DataStreamer，搜索run方法</p>
<p>DataStreamer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">long</span> lastPacket = Time.monotonicNow();</span><br><span class="line">	TraceScope scope = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">while</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">	  <span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line">	  <span class="keyword">if</span> (errorState.hasError()) &#123;</span><br><span class="line">		closeResponder();</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  DFSPacket one;</span><br><span class="line">	  <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// process datanode IO errors if any</span></span><br><span class="line">		<span class="keyword">boolean</span> doSleep = processDatanodeOrExternalError();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> halfSocketTimeout = dfsClient.getConf().getSocketTimeout()/<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">		  <span class="comment">// wait for a packet to be sent.</span></span><br><span class="line">		  <span class="keyword">long</span> now = Time.monotonicNow();</span><br><span class="line">		  <span class="keyword">while</span> ((!shouldStop() &amp;&amp; dataQueue.size() == <span class="number">0</span> &amp;&amp;</span><br><span class="line">			  (stage != BlockConstructionStage.DATA_STREAMING ||</span><br><span class="line">				  now - lastPacket &lt; halfSocketTimeout)) || doSleep) &#123;</span><br><span class="line">			<span class="keyword">long</span> timeout = halfSocketTimeout - (now-lastPacket);</span><br><span class="line">			timeout = timeout &lt;= <span class="number">0</span> ? <span class="number">1000</span> : timeout;</span><br><span class="line">			timeout = (stage == BlockConstructionStage.DATA_STREAMING)?</span><br><span class="line">				timeout : <span class="number">1000</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			  <span class="comment">// 如果dataQueue里面没有数据，代码会阻塞在这儿</span></span><br><span class="line">			  dataQueue.wait(timeout); <span class="comment">// 接收到notify消息</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">			  LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			doSleep = <span class="keyword">false</span>;</span><br><span class="line">			now = Time.monotonicNow();</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="keyword">if</span> (shouldStop()) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="comment">// get packet to be sent.</span></span><br><span class="line">		  <span class="keyword">if</span> (dataQueue.isEmpty()) &#123;</span><br><span class="line">			one = createHeartbeatPacket();</span><br><span class="line">		  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			  backOffIfNecessary();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			  LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//  队列不为空，从队列中取出packet</span></span><br><span class="line">			one = dataQueue.getFirst(); <span class="comment">// regular data packet</span></span><br><span class="line">			SpanId[] parents = one.getTraceParents();</span><br><span class="line">			<span class="keyword">if</span> (parents.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			  scope = dfsClient.getTracer().</span><br><span class="line">				  newScope(<span class="string">"dataStreamer"</span>, parents[<span class="number">0</span>]);</span><br><span class="line">			  scope.getSpan().setParents(parents);</span><br><span class="line">			&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get new block from namenode.</span></span><br><span class="line">		<span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">		  LOG.debug(<span class="string">"stage="</span> + stage + <span class="string">", "</span> + <span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_CREATE) &#123;</span><br><span class="line">		  LOG.debug(<span class="string">"Allocating new block: &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">		  <span class="comment">// 步骤一：向NameNode 申请block 并建立数据管道</span></span><br><span class="line">		  setPipeline(nextBlockOutputStream());</span><br><span class="line">		  <span class="comment">// 步骤二：启动ResponseProcessor用来监听packet发送是否成功</span></span><br><span class="line">		  initDataStreaming();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_APPEND) &#123;</span><br><span class="line">		  setupPipelineForAppendOrRecovery();</span><br><span class="line">		  <span class="keyword">if</span> (streamerClosed) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">		  initDataStreaming();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> lastByteOffsetInBlock = one.getLastByteOffsetBlock();</span><br><span class="line">		<span class="keyword">if</span> (lastByteOffsetInBlock &gt; stat.getBlockSize()) &#123;</span><br><span class="line">		  <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"BlockSize "</span> + stat.getBlockSize() +</span><br><span class="line">			  <span class="string">" &lt; lastByteOffsetInBlock, "</span> + <span class="keyword">this</span> + <span class="string">", "</span> + one);</span><br><span class="line">		&#125;</span><br><span class="line">		… …</span><br><span class="line">		<span class="comment">// send the packet</span></span><br><span class="line">		SpanId spanId = SpanId.INVALID;</span><br><span class="line">		<span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line"></span><br><span class="line">		  <span class="comment">// move packet from dataQueue to ackQueue</span></span><br><span class="line">		  <span class="keyword">if</span> (!one.isHeartbeatPacket()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">			  spanId = scope.getSpanId();</span><br><span class="line">			  scope.detach();</span><br><span class="line"></span><br><span class="line">			  one.setTraceScope(scope);</span><br><span class="line">			&#125;</span><br><span class="line">			scope = <span class="keyword">null</span>;</span><br><span class="line">			<span class="comment">// 步骤三：从dataQueue 把要发送的这个packet 移除出去</span></span><br><span class="line">			dataQueue.removeFirst();</span><br><span class="line">			<span class="comment">// 步骤四：然后往ackQueue 里面添加这个packet</span></span><br><span class="line">			ackQueue.addLast(one);</span><br><span class="line">			packetSendTime.put(one.getSeqno(), Time.monotonicNow());</span><br><span class="line">			dataQueue.notifyAll();</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		LOG.debug(<span class="string">"&#123;&#125; sending &#123;&#125;"</span>, <span class="keyword">this</span>, one);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// write out data to remote datanode</span></span><br><span class="line">		<span class="keyword">try</span> (TraceScope ignored = dfsClient.getTracer().</span><br><span class="line">			newScope(<span class="string">"DataStreamer#writeTo"</span>, spanId)) &#123;</span><br><span class="line">		  <span class="comment">//  将数据写出去</span></span><br><span class="line">		  one.writeTo(blockStream);</span><br><span class="line">		  blockStream.flush();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		  errorState.markFirstNodeIfNotMarked();</span><br><span class="line">		  <span class="keyword">throw</span> e;</span><br><span class="line">		&#125;</span><br><span class="line">		… …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击nextBlockOutputStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> LocatedBlock <span class="title">nextBlockOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  LocatedBlock lb;</span><br><span class="line">  DatanodeInfo[] nodes;</span><br><span class="line">  StorageType[] nextStorageTypes;</span><br><span class="line">  String[] nextStorageIDs;</span><br><span class="line">  <span class="keyword">int</span> count = dfsClient.getConf().getNumBlockWriteRetry();</span><br><span class="line">  <span class="keyword">boolean</span> success;</span><br><span class="line">  <span class="keyword">final</span> ExtendedBlock oldBlock = block.getCurrentBlock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    errorState.resetInternalError();</span><br><span class="line">    lastException.clear();</span><br><span class="line"></span><br><span class="line">    DatanodeInfo[] excluded = getExcludedNodes();</span><br><span class="line">	<span class="comment">// 向NN获取向哪个DN写数据</span></span><br><span class="line">    lb = locateFollowingBlock(</span><br><span class="line">        excluded.length &gt; <span class="number">0</span> ? excluded : <span class="keyword">null</span>, oldBlock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建管道</span></span><br><span class="line">    success = createBlockOutputStream(nodes, nextStorageTypes, nextStorageIDs,</span><br><span class="line">          <span class="number">0L</span>, <span class="keyword">false</span>);</span><br><span class="line">    … …</span><br><span class="line">  &#125; <span class="keyword">while</span> (!success &amp;&amp; --count &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unable to create new block."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> lb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlock <span class="title">locateFollowingBlock</span><span class="params">(DatanodeInfo[] excluded,</span></span></span><br><span class="line"><span class="function"><span class="params">    ExtendedBlock oldBlock)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> DFSOutputStream.addBlock(excluded, dfsClient, src, oldBlock,</span><br><span class="line">      stat.getFileId(), favoredNodes, addBlockFlags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> LocatedBlock <span class="title">addBlock</span><span class="params">(DatanodeInfo[] excludedNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">      DFSClient dfsClient, String src, ExtendedBlock prevBlock, <span class="keyword">long</span> fileId,</span></span></span><br><span class="line"><span class="function"><span class="params">      String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; allocFlags)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	  ... ...</span><br><span class="line">	  <span class="comment">// 向NN获取向哪个DN写数据</span></span><br><span class="line">	  <span class="keyword">return</span> dfsClient.namenode.addBlock(src, dfsClient.clientName, prevBlock,</span><br><span class="line">            excludedNodes, fileId, favoredNodes, allocFlags);</span><br><span class="line">	  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LocatedBlock <span class="title">addBlock</span><span class="params">(String src, String clientName,</span></span></span><br><span class="line"><span class="function"><span class="params">      ExtendedBlock previous, DatanodeInfo[] excludeNodes, <span class="keyword">long</span> fileId,</span></span></span><br><span class="line"><span class="function"><span class="params">      String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; addBlockFlags)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>

<p>ctrl + h 点击NameNodeRpcServer，在该类中搜索addBlock</p>
<p>NameNodeRpcServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> LocatedBlock <span class="title">addBlock</span><span class="params">(String src, String clientName,</span></span></span><br><span class="line"><span class="function"><span class="params">    ExtendedBlock previous, DatanodeInfo[] excludedNodes, <span class="keyword">long</span> fileId,</span></span></span><br><span class="line"><span class="function"><span class="params">    String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; addBlockFlags)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  checkNNStartup();</span><br><span class="line">  LocatedBlock locatedBlock = namesystem.getAdditionalBlock(src, fileId,</span><br><span class="line">      clientName, previous, excludedNodes, favoredNodes, addBlockFlags);</span><br><span class="line">  <span class="keyword">if</span> (locatedBlock != <span class="keyword">null</span>) &#123;</span><br><span class="line">    metrics.incrAddBlockOps();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> locatedBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FSNamesystrm.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LocatedBlock <span class="title">getAdditionalBlock</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    String src, <span class="keyword">long</span> fileId, String clientName, ExtendedBlock previous,</span></span></span><br><span class="line"><span class="function"><span class="params">    DatanodeInfo[] excludedNodes, String[] favoredNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">    EnumSet&lt;AddBlockFlag&gt; flags)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String operationName = <span class="string">"getAdditionalBlock"</span>;</span><br><span class="line">  NameNode.stateChangeLog.debug(<span class="string">"BLOCK* getAdditionalBlock: &#123;&#125;  inodeId &#123;&#125;"</span> +</span><br><span class="line">      <span class="string">" for &#123;&#125;"</span>, src, fileId, clientName);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">  <span class="comment">// 选择块存储位置</span></span><br><span class="line">  DatanodeStorageInfo[] targets = FSDirWriteFileOp.chooseTargetForNewBlock(</span><br><span class="line">      blockManager, src, excludedNodes, favoredNodes, flags, r);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> lb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> DatanodeStorageInfo[] chooseTargetForNewBlock(</span><br><span class="line">    BlockManager bm, String src, DatanodeInfo[] excludedNodes,</span><br><span class="line">    String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; flags,</span><br><span class="line">    ValidateAddBlockResult r) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> bm.chooseTarget4NewBlock(src, r.numTargets, clientNode,</span><br><span class="line">                                  excludedNodesSet, r.blockSize,</span><br><span class="line">                                  favoredNodesList, r.storagePolicyID,</span><br><span class="line">                                  r.blockType, r.ecPolicy, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DatanodeStorageInfo[] chooseTarget4NewBlock(... ...</span><br><span class="line">  ) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ... ...</span><br><span class="line">	  </span><br><span class="line">  <span class="keyword">final</span> DatanodeStorageInfo[] targets = blockplacement.chooseTarget(src,</span><br><span class="line">      numOfReplicas, client, excludedNodes, blocksize, </span><br><span class="line">      favoredDatanodeDescriptors, storagePolicy, flags);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">return</span> targets;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DatanodeStorageInfo[] chooseTarget(String src,</span><br><span class="line">    <span class="keyword">int</span> numOfReplicas, Node writer,</span><br><span class="line">    Set&lt;Node&gt; excludedNodes,</span><br><span class="line">    <span class="keyword">long</span> blocksize,</span><br><span class="line">    List&lt;DatanodeDescriptor&gt; favoredNodes,</span><br><span class="line">    BlockStoragePolicy storagePolicy,</span><br><span class="line">    EnumSet&lt;AddBlockFlag&gt; flags) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> chooseTarget(src, numOfReplicas, writer, </span><br><span class="line">      <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;(numOfReplicas), <span class="keyword">false</span>,</span><br><span class="line">      excludedNodes, blocksize, storagePolicy, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> DatanodeStorageInfo[] chooseTarget(String srcPath,</span><br><span class="line">    <span class="keyword">int</span> numOfReplicas,</span><br><span class="line">    Node writer,</span><br><span class="line">    List&lt;DatanodeStorageInfo&gt; chosen,</span><br><span class="line">    <span class="keyword">boolean</span> returnChosenNodes,</span><br><span class="line">    Set&lt;Node&gt; excludedNodes,</span><br><span class="line">    <span class="keyword">long</span> blocksize,</span><br><span class="line">    BlockStoragePolicy storagePolicy,</span><br><span class="line">EnumSet&lt;AddBlockFlag&gt; flags);</span><br></pre></td></tr></table></figure>

<p>Crtl + h 查找chooseTarget实现类BlockPlacementPolicyDefault.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DatanodeStorageInfo[] chooseTarget(String srcPath,</span><br><span class="line">    <span class="keyword">int</span> numOfReplicas,</span><br><span class="line">    Node writer,</span><br><span class="line">    List&lt;DatanodeStorageInfo&gt; chosenNodes,</span><br><span class="line">    <span class="keyword">boolean</span> returnChosenNodes,</span><br><span class="line">    Set&lt;Node&gt; excludedNodes,</span><br><span class="line">    <span class="keyword">long</span> blocksize,</span><br><span class="line">    <span class="keyword">final</span> BlockStoragePolicy storagePolicy,</span><br><span class="line">    EnumSet&lt;AddBlockFlag&gt; flags) &#123;</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">return</span> chooseTarget(numOfReplicas, writer, chosenNodes, returnChosenNodes,</span><br><span class="line">      excludedNodes, blocksize, storagePolicy, flags, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DatanodeStorageInfo[] chooseTarget(<span class="keyword">int</span> numOfReplicas,</span><br><span class="line">  Node writer,</span><br><span class="line">  List&lt;DatanodeStorageInfo&gt; chosenStorage,</span><br><span class="line">  <span class="keyword">boolean</span> returnChosenNodes,</span><br><span class="line">  Set&lt;Node&gt; excludedNodes,</span><br><span class="line">  <span class="keyword">long</span> blocksize,</span><br><span class="line">  <span class="keyword">final</span> BlockStoragePolicy storagePolicy,</span><br><span class="line">  EnumSet&lt;AddBlockFlag&gt; addBlockFlags,</span><br><span class="line">  EnumMap&lt;StorageType, Integer&gt; sTypes) &#123;</span><br><span class="line">  … …</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">int</span>[] result = getMaxNodesPerRack(chosenStorage.size(), numOfReplicas);</span><br><span class="line">  numOfReplicas = result[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">int</span> maxNodesPerRack = result[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">for</span> (DatanodeStorageInfo storage : chosenStorage) &#123;</span><br><span class="line">    <span class="comment">// add localMachine and related nodes to excludedNodes</span></span><br><span class="line">	<span class="comment">// 获取不可用的DN</span></span><br><span class="line">    addToExcludedNodes(storage.getDatanodeDescriptor(), excludedNodes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  List&lt;DatanodeStorageInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">  Node localNode = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> avoidStaleNodes = (stats != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; stats.isAvoidingStaleDataNodesForWrite());</span><br><span class="line">  <span class="comment">//   </span></span><br><span class="line">  <span class="keyword">boolean</span> avoidLocalNode = (addBlockFlags != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; addBlockFlags.contains(AddBlockFlag.NO_LOCAL_WRITE)</span><br><span class="line">      &amp;&amp; writer != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; !excludedNodes.contains(writer));</span><br><span class="line">  <span class="comment">// Attempt to exclude local node if the client suggests so. If no enough</span></span><br><span class="line">  <span class="comment">// nodes can be obtained, it falls back to the default block placement</span></span><br><span class="line">  <span class="comment">// policy.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 有数据正在写，避免都写入本地</span></span><br><span class="line">  <span class="keyword">if</span> (avoidLocalNode) &#123;</span><br><span class="line">    results = <span class="keyword">new</span> ArrayList&lt;&gt;(chosenStorage);</span><br><span class="line">    Set&lt;Node&gt; excludedNodeCopy = <span class="keyword">new</span> HashSet&lt;&gt;(excludedNodes);</span><br><span class="line">    <span class="keyword">if</span> (writer != <span class="keyword">null</span>) &#123;</span><br><span class="line">      excludedNodeCopy.add(writer);</span><br><span class="line">    &#125;</span><br><span class="line">    localNode = chooseTarget(numOfReplicas, writer,</span><br><span class="line">        excludedNodeCopy, blocksize, maxNodesPerRack, results,</span><br><span class="line">        avoidStaleNodes, storagePolicy,</span><br><span class="line">        EnumSet.noneOf(StorageType<span class="class">.<span class="keyword">class</span>), <span class="title">results</span>.<span class="title">isEmpty</span>(), <span class="title">sTypes</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (results.size() &lt; numOfReplicas) &#123;</span><br><span class="line">      <span class="comment">// not enough nodes; discard results and fall back</span></span><br><span class="line">      results = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results == <span class="keyword">null</span>) &#123;</span><br><span class="line">    results = <span class="keyword">new</span> ArrayList&lt;&gt;(chosenStorage);</span><br><span class="line">	<span class="comment">// 真正的选择DN节点</span></span><br><span class="line">    localNode = chooseTarget(numOfReplicas, writer, excludedNodes,</span><br><span class="line">        blocksize, maxNodesPerRack, results, avoidStaleNodes,</span><br><span class="line">        storagePolicy, EnumSet.noneOf(StorageType<span class="class">.<span class="keyword">class</span>), <span class="title">results</span>.<span class="title">isEmpty</span>(),</span></span><br><span class="line"><span class="class">        <span class="title">sTypes</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!returnChosenNodes) &#123;  </span><br><span class="line">    results.removeAll(chosenStorage);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// sorting nodes to form a pipeline</span></span><br><span class="line">  <span class="keyword">return</span> getPipeline(</span><br><span class="line">      (writer != <span class="keyword">null</span> &amp;&amp; writer <span class="keyword">instanceof</span> DatanodeDescriptor) ? writer</span><br><span class="line">          : localNode,</span><br><span class="line">      results.toArray(<span class="keyword">new</span> DatanodeStorageInfo[results.size()]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">chooseTarget</span><span class="params">(<span class="keyword">int</span> numOfReplicas,</span></span></span><br><span class="line"><span class="function"><span class="params">   ... ...)</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">   writer = chooseTargetInOrder(numOfReplicas, writer, excludedNodes, blocksize,</span><br><span class="line">          maxNodesPerRack, results, avoidStaleNodes, newBlock, storageTypes);</span><br><span class="line">   ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Node <span class="title">chooseTargetInOrder</span><span class="params">(<span class="keyword">int</span> numOfReplicas, </span></span></span><br><span class="line"><span class="function"><span class="params">                               Node writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Set&lt;Node&gt; excludedNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> <span class="keyword">long</span> blocksize,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> <span class="keyword">int</span> maxNodesPerRack,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; results,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> <span class="keyword">boolean</span> avoidStaleNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> <span class="keyword">boolean</span> newBlock,</span></span></span><br><span class="line"><span class="function"><span class="params">                               EnumMap&lt;StorageType, Integer&gt; storageTypes)</span></span></span><br><span class="line"><span class="function">                               <span class="keyword">throws</span> NotEnoughReplicasException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numOfResults = results.size();</span><br><span class="line">  <span class="keyword">if</span> (numOfResults == <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="comment">// 第一个块存储在当前节点</span></span><br><span class="line">    DatanodeStorageInfo storageInfo = chooseLocalStorage(writer,</span><br><span class="line">        excludedNodes, blocksize, maxNodesPerRack, results, avoidStaleNodes,</span><br><span class="line">        storageTypes, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    writer = (storageInfo != <span class="keyword">null</span>) ? storageInfo.getDatanodeDescriptor()</span><br><span class="line">                                   : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> DatanodeDescriptor dn0 = results.get(<span class="number">0</span>).getDatanodeDescriptor();</span><br><span class="line">  <span class="comment">// 第二个块存储在另外一个机架</span></span><br><span class="line">  <span class="keyword">if</span> (numOfResults &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">        results, avoidStaleNodes, storageTypes);</span><br><span class="line">    <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (numOfResults &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor dn1 = results.get(<span class="number">1</span>).getDatanodeDescriptor();</span><br><span class="line">	<span class="comment">// 如果第一个和第二个在同一个机架，那么第三个放在其他机架</span></span><br><span class="line">    <span class="keyword">if</span> (clusterMap.isOnSameRack(dn0, dn1)) &#123;</span><br><span class="line">      chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">          results, avoidStaleNodes, storageTypes);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newBlock)&#123;</span><br><span class="line">	  <span class="comment">// 如果是新块，和第二个块存储在同一个机架</span></span><br><span class="line">      chooseLocalRack(dn1, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">          results, avoidStaleNodes, storageTypes);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	  <span class="comment">// 如果不是新块，放在当前机架</span></span><br><span class="line">      chooseLocalRack(writer, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">          results, avoidStaleNodes, storageTypes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  chooseRandom(numOfReplicas, NodeBase.ROOT, excludedNodes, blocksize,</span><br><span class="line">      maxNodesPerRack, results, avoidStaleNodes, storageTypes);</span><br><span class="line">  <span class="keyword">return</span> writer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-建立管道之Socket发送"><a href="#3-1-3-建立管道之Socket发送" class="headerlink" title="3.1.3 建立管道之Socket发送"></a>3.1.3 建立管道之Socket发送</h3><p>点击nextBlockOutputStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> LocatedBlock <span class="title">nextBlockOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  LocatedBlock lb;</span><br><span class="line">  DatanodeInfo[] nodes;</span><br><span class="line">  StorageType[] nextStorageTypes;</span><br><span class="line">  String[] nextStorageIDs;</span><br><span class="line">  <span class="keyword">int</span> count = dfsClient.getConf().getNumBlockWriteRetry();</span><br><span class="line">  <span class="keyword">boolean</span> success;</span><br><span class="line">  <span class="keyword">final</span> ExtendedBlock oldBlock = block.getCurrentBlock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    errorState.resetInternalError();</span><br><span class="line">    lastException.clear();</span><br><span class="line"></span><br><span class="line">    DatanodeInfo[] excluded = getExcludedNodes();</span><br><span class="line">	<span class="comment">// 向NN获取向哪个DN写数据</span></span><br><span class="line">    lb = locateFollowingBlock(</span><br><span class="line">        excluded.length &gt; <span class="number">0</span> ? excluded : <span class="keyword">null</span>, oldBlock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建管道</span></span><br><span class="line">    success = createBlockOutputStream(nodes, nextStorageTypes, nextStorageIDs,</span><br><span class="line">          <span class="number">0L</span>, <span class="keyword">false</span>);</span><br><span class="line">    … …</span><br><span class="line">  &#125; <span class="keyword">while</span> (!success &amp;&amp; --count &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unable to create new block."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> lb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">createBlockOutputStream</span><span class="params">(DatanodeInfo[] nodes,</span></span></span><br><span class="line"><span class="function"><span class="params">      StorageType[] nodeStorageTypes, String[] nodeStorageIDs,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">long</span> newGS, <span class="keyword">boolean</span> recoveryFlag)</span> </span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">	<span class="comment">// 和DN创建socket</span></span><br><span class="line">	s = createSocketForPipeline(nodes[<span class="number">0</span>], nodes.length, dfsClient);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 获取输出流，用于写数据到DN</span></span><br><span class="line">	OutputStream unbufOut = NetUtils.getOutputStream(s, writeTimeout);</span><br><span class="line">	<span class="comment">// 获取输入流，用于读取写数据到DN的结果</span></span><br><span class="line">    InputStream unbufIn = NetUtils.getInputStream(s, readTimeout);</span><br><span class="line">	</span><br><span class="line">    IOStreamPair saslStreams = dfsClient.saslClient.socketSend(s,</span><br><span class="line">        unbufOut, unbufIn, dfsClient, accessToken, nodes[<span class="number">0</span>]);</span><br><span class="line">    unbufOut = saslStreams.out;</span><br><span class="line">    unbufIn = saslStreams.in;</span><br><span class="line">    out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(unbufOut,</span><br><span class="line">        DFSUtilClient.getSmallBufferSize(dfsClient.getConfiguration())));</span><br><span class="line">    blockReplyStream = <span class="keyword">new</span> DataInputStream(unbufIn);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 发送数据</span></span><br><span class="line">	<span class="keyword">new</span> Sender(out).writeBlock(blockCopy, nodeStorageTypes[<span class="number">0</span>], accessToken,</span><br><span class="line">            dfsClient.clientName, nodes, nodeStorageTypes, <span class="keyword">null</span>, bcs,</span><br><span class="line">            nodes.length, block.getNumBytes(), bytesSent, newGS,</span><br><span class="line">            checksum4WriteBlock, cachingStrategy.get(), isLazyPersistFile,</span><br><span class="line">            (targetPinnings != <span class="keyword">null</span> &amp;&amp; targetPinnings[<span class="number">0</span>]), targetPinnings,</span><br><span class="line">            nodeStorageIDs[<span class="number">0</span>], nodeStorageIDs);</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBlock</span><span class="params">(... ...)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  send(out, Op.WRITE_BLOCK, proto.build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-4-建立管道之Socket接收"><a href="#3-1-4-建立管道之Socket接收" class="headerlink" title="3.1.4 建立管道之Socket接收"></a>3.1.4 建立管道之Socket接收</h3><p>Ctrl +n 全局查找DataXceiverServer.java，在该类中查找run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Peer peer = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (datanode.shouldRun &amp;&amp; !datanode.shutdownForUpgrade) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 接收socket的请求</span></span><br><span class="line">      peer = peerServer.accept();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the xceiver count is not exceeded</span></span><br><span class="line">      <span class="keyword">int</span> curXceiverCount = datanode.getXceiverCount();</span><br><span class="line">      <span class="keyword">if</span> (curXceiverCount &gt; maxXceiverCount) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Xceiver count "</span> + curXceiverCount</span><br><span class="line">            + <span class="string">" exceeds the limit of concurrent xcievers: "</span></span><br><span class="line">            + maxXceiverCount);</span><br><span class="line">      &#125;</span><br><span class="line">	  <span class="comment">// 客户端每发送一个block，都启动一个DataXceiver去处理block</span></span><br><span class="line">      <span class="keyword">new</span> Daemon(datanode.threadGroup,</span><br><span class="line">          DataXceiver.create(peer, datanode, <span class="keyword">this</span>))</span><br><span class="line">          .start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketTimeoutException ignored) &#123;</span><br><span class="line">      ... ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击DataXceiver（线程），查找run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> opsProcessed = <span class="number">0</span>;</span><br><span class="line">  Op op = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      xceiver = Thread.currentThread();</span><br><span class="line">    &#125;</span><br><span class="line">    dataXceiverServer.addPeer(peer, Thread.currentThread(), <span class="keyword">this</span>);</span><br><span class="line">    peer.setWriteTimeout(datanode.getDnConf().socketWriteTimeout);</span><br><span class="line">    InputStream input = socketIn;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      IOStreamPair saslStreams = datanode.saslServer.receive(peer, socketOut,</span><br><span class="line">        socketIn, datanode.getXferAddress().getPort(),</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">super</span>.initialize(<span class="keyword">new</span> DataInputStream(input));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      updateCurrentThreadName(<span class="string">"Waiting for operation #"</span> + (opsProcessed + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (opsProcessed != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">assert</span> dnConf.socketKeepaliveTimeout &gt; <span class="number">0</span>;</span><br><span class="line">          peer.setReadTimeout(dnConf.socketKeepaliveTimeout);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          peer.setReadTimeout(dnConf.socketTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 读取这次数据的请求类型</span></span><br><span class="line">        op = readOp();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedIOException ignored) &#123;</span><br><span class="line">        <span class="comment">// Time out while we wait for client rpc</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (EOFException | ClosedChannelException e) &#123;</span><br><span class="line">        <span class="comment">// Since we optimistically expect the next op, it's quite normal to</span></span><br><span class="line">        <span class="comment">// get EOF here.</span></span><br><span class="line">        LOG.debug(<span class="string">"Cached &#123;&#125; closing after &#123;&#125; ops.  "</span> +</span><br><span class="line">            <span class="string">"This message is usually benign."</span>, peer, opsProcessed);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException err) &#123;</span><br><span class="line">        incrDatanodeNetworkErrors();</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// restore normal timeout</span></span><br><span class="line">      <span class="keyword">if</span> (opsProcessed != <span class="number">0</span>) &#123;</span><br><span class="line">        peer.setReadTimeout(dnConf.socketTimeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      opStartTime = monotonicNow();</span><br><span class="line">	  <span class="comment">// 根据操作类型处理我们的数据</span></span><br><span class="line">      processOp(op);</span><br><span class="line">      ++opsProcessed;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((peer != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">        (!peer.isClosed() &amp;&amp; dnConf.socketKeepaliveTimeout &gt; <span class="number">0</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ... ... </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processOp</span><span class="params">(Op op)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(op) &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">case</span> WRITE_BLOCK:</span><br><span class="line">    opWriteBlock(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unknown op "</span> + op + <span class="string">" in data stream"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">opWriteBlock</span><span class="params">(DataInputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> OpWriteBlockProto proto = OpWriteBlockProto.parseFrom(vintPrefixed(in));</span><br><span class="line">  <span class="keyword">final</span> DatanodeInfo[] targets = PBHelperClient.convert(proto.getTargetsList());</span><br><span class="line">  TraceScope traceScope = continueTraceSpan(proto.getHeader(),</span><br><span class="line">      proto.getClass().getSimpleName());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    writeBlock(PBHelperClient.convert(proto.getHeader().getBaseHeader().getBlock()),</span><br><span class="line">        PBHelperClient.convertStorageType(proto.getStorageType()),</span><br><span class="line">        PBHelperClient.convert(proto.getHeader().getBaseHeader().getToken()),</span><br><span class="line">        proto.getHeader().getClientName(),</span><br><span class="line">        targets,</span><br><span class="line">        PBHelperClient.convertStorageTypes(proto.getTargetStorageTypesList(), targets.length),</span><br><span class="line">        PBHelperClient.convert(proto.getSource()),</span><br><span class="line">        fromProto(proto.getStage()),</span><br><span class="line">        proto.getPipelineSize(),</span><br><span class="line">        proto.getMinBytesRcvd(), proto.getMaxBytesRcvd(),</span><br><span class="line">        proto.getLatestGenerationStamp(),</span><br><span class="line">        fromProto(proto.getRequestedChecksum()),</span><br><span class="line">        (proto.hasCachingStrategy() ?</span><br><span class="line">            getCachingStrategy(proto.getCachingStrategy()) :</span><br><span class="line">          CachingStrategy.newDefaultStrategy()),</span><br><span class="line">        (proto.hasAllowLazyPersist() ? proto.getAllowLazyPersist() : <span class="keyword">false</span>),</span><br><span class="line">        (proto.hasPinning() ? proto.getPinning(): <span class="keyword">false</span>),</span><br><span class="line">        (PBHelperClient.convertBooleanList(proto.getTargetPinningsList())),</span><br><span class="line">        proto.getStorageId(),</span><br><span class="line">        proto.getTargetStorageIdsList().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (traceScope != <span class="keyword">null</span>) traceScope.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ctrl +alt +b 查找writeBlock的实现类DataXceiver.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBlock</span><span class="params">(... ...)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Replica replica;</span><br><span class="line">    <span class="keyword">if</span> (isDatanode || </span><br><span class="line">        stage != BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) &#123;</span><br><span class="line">      <span class="comment">// open a block receiver</span></span><br><span class="line">	  <span class="comment">// 创建一个BlockReceiver</span></span><br><span class="line">      setCurrentBlockReceiver(getBlockReceiver(block, storageType, in,</span><br><span class="line">          peer.getRemoteAddressString(),</span><br><span class="line">          peer.getLocalAddressString(),</span><br><span class="line">          stage, latestGenerationStamp, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">          clientname, srcDataNode, datanode, requestedChecksum,</span><br><span class="line">          cachingStrategy, allowLazyPersist, pinning, storageId));</span><br><span class="line">      replica = blockReceiver.getReplica();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      replica = datanode.data.recoverClose(</span><br><span class="line">          block, latestGenerationStamp, minBytesRcvd);</span><br><span class="line">    &#125;</span><br><span class="line">    storageUuid = replica.getStorageUuid();</span><br><span class="line">    isOnTransientStorage = replica.isOnTransientStorage();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Connect to downstream machine, if appropriate</span></span><br><span class="line">    <span class="comment">// 继续连接下游的机器</span></span><br><span class="line">    <span class="keyword">if</span> (targets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      InetSocketAddress mirrorTarget = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// Connect to backup machine</span></span><br><span class="line">      mirrorNode = targets[<span class="number">0</span>].getXferAddr(connectToDnViaHostname);</span><br><span class="line">      LOG.debug(<span class="string">"Connecting to datanode &#123;&#125;"</span>, mirrorNode);</span><br><span class="line">      mirrorTarget = NetUtils.createSocketAddr(mirrorNode);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// 向新的副本发送socket</span></span><br><span class="line">      mirrorSock = datanode.newSocket();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        ... ...</span><br><span class="line">        <span class="keyword">if</span> (targetPinnings != <span class="keyword">null</span> &amp;&amp; targetPinnings.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		  <span class="comment">// 往下游socket发送数据</span></span><br><span class="line">          <span class="keyword">new</span> Sender(mirrorOut).writeBlock(originalBlock, targetStorageTypes[<span class="number">0</span>],</span><br><span class="line">              blockToken, clientname, targets, targetStorageTypes,</span><br><span class="line">              srcDataNode, stage, pipelineSize, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">              latestGenerationStamp, requestedChecksum, cachingStrategy,</span><br><span class="line">              allowLazyPersist, targetPinnings[<span class="number">0</span>], targetPinnings,</span><br><span class="line">              targetStorageId, targetStorageIds);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">new</span> Sender(mirrorOut).writeBlock(originalBlock, targetStorageTypes[<span class="number">0</span>],</span><br><span class="line">              blockToken, clientname, targets, targetStorageTypes,</span><br><span class="line">              srcDataNode, stage, pipelineSize, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">              latestGenerationStamp, requestedChecksum, cachingStrategy,</span><br><span class="line">              allowLazyPersist, <span class="keyword">false</span>, targetPinnings,</span><br><span class="line">              targetStorageId, targetStorageIds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mirrorOut.flush();</span><br><span class="line"></span><br><span class="line">        DataNodeFaultInjector.get().writeBlockAfterFlush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// read connect ack (only for clients, not for replication req)</span></span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          BlockOpResponseProto connectAck =</span><br><span class="line">            BlockOpResponseProto.parseFrom(PBHelperClient.vintPrefixed(mirrorIn));</span><br><span class="line">          mirrorInStatus = connectAck.getStatus();</span><br><span class="line">          firstBadLink = connectAck.getFirstBadLink();</span><br><span class="line">          <span class="keyword">if</span> (mirrorInStatus != SUCCESS) &#123;</span><br><span class="line">            LOG.debug(<span class="string">"Datanode &#123;&#125; got response for connect"</span> +</span><br><span class="line">                <span class="string">"ack  from downstream datanode with firstbadlink as &#123;&#125;"</span>,</span><br><span class="line">                targets.length, firstBadLink);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      … …</span><br><span class="line"></span><br><span class="line">  <span class="comment">//update metrics</span></span><br><span class="line">  datanode.getMetrics().addWriteBlockOp(elapsed());</span><br><span class="line">  datanode.getMetrics().incrWritesFromClient(peer.isLocal(), size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BlockReceiver <span class="title">getBlockReceiver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> ExtendedBlock block, <span class="keyword">final</span> StorageType storageType,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> DataInputStream in,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String inAddr, <span class="keyword">final</span> String myAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> BlockConstructionStage stage,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">long</span> newGs, <span class="keyword">final</span> <span class="keyword">long</span> minBytesRcvd, <span class="keyword">final</span> <span class="keyword">long</span> maxBytesRcvd,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String clientname, <span class="keyword">final</span> DatanodeInfo srcDataNode,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> DataNode dn, DataChecksum requestedChecksum,</span></span></span><br><span class="line"><span class="function"><span class="params">    CachingStrategy cachingStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyPersist,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">boolean</span> pinning,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String storageId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> BlockReceiver(block, storageType, in,</span><br><span class="line">      inAddr, myAddr, stage, newGs, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">      clientname, srcDataNode, dn, requestedChecksum,</span><br><span class="line">      cachingStrategy, allowLazyPersist, pinning, storageId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BlockReceiver(<span class="keyword">final</span> ExtendedBlock block, <span class="keyword">final</span> StorageType storageType,</span><br><span class="line">  <span class="keyword">final</span> DataInputStream in,</span><br><span class="line">  <span class="keyword">final</span> String inAddr, <span class="keyword">final</span> String myAddr,</span><br><span class="line">  <span class="keyword">final</span> BlockConstructionStage stage, </span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> newGs, <span class="keyword">final</span> <span class="keyword">long</span> minBytesRcvd, <span class="keyword">final</span> <span class="keyword">long</span> maxBytesRcvd, </span><br><span class="line">  <span class="keyword">final</span> String clientname, <span class="keyword">final</span> DatanodeInfo srcDataNode,</span><br><span class="line">  <span class="keyword">final</span> DataNode datanode, DataChecksum requestedChecksum,</span><br><span class="line">  CachingStrategy cachingStrategy,</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyPersist,</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> pinning,</span><br><span class="line">  <span class="keyword">final</span> String storageId) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (isDatanode) &#123; <span class="comment">//replication or move</span></span><br><span class="line">    replicaHandler =</span><br><span class="line">        datanode.data.createTemporary(storageType, storageId, block, <span class="keyword">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">    <span class="keyword">case</span> PIPELINE_SETUP_CREATE:</span><br><span class="line">	  <span class="comment">// 创建管道</span></span><br><span class="line">      replicaHandler = datanode.data.createRbw(storageType, storageId,</span><br><span class="line">          block, allowLazyPersist);</span><br><span class="line">      datanode.notifyNamenodeReceivingBlock(</span><br><span class="line">          block, replicaHandler.getReplica().getStorageUuid());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unsupported stage "</span> + stage + </span><br><span class="line">          <span class="string">" while receiving block "</span> + block + <span class="string">" from "</span> + inAddr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReplicaHandler <span class="title">createRbw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    StorageType storageType, String storageId, ExtendedBlock b,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> allowLazyPersist)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> (AutoCloseableLock lock = datasetLock.acquire()) &#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">      ref = volumes.getNextVolume(storageType, storageId, b.getNumBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FsVolumeImpl v = (FsVolumeImpl) ref.getVolume();</span><br><span class="line">    <span class="comment">// create an rbw file to hold block in the designated volume</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowLazyPersist &amp;&amp; !v.isTransientStorage()) &#123;</span><br><span class="line">      datanode.getMetrics().incrRamDiskBlocksWriteFallback();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReplicaInPipeline newReplicaInfo;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 创建输出流的临时写文件 </span></span><br><span class="line">      newReplicaInfo = v.createRbw(b);</span><br><span class="line">      <span class="keyword">if</span> (newReplicaInfo.getReplicaInfo().getState() != ReplicaState.RBW) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"CreateRBW returned a replica of state "</span></span><br><span class="line">            + newReplicaInfo.getReplicaInfo().getState()</span><br><span class="line">            + <span class="string">" for block "</span> + b.getBlockId());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      IOUtils.cleanup(<span class="keyword">null</span>, ref);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volumeMap.add(b.getBlockPoolId(), newReplicaInfo.getReplicaInfo());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReplicaHandler(newReplicaInfo, ref);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReplicaHandler <span class="title">createRbw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    StorageType storageType, String storageId, ExtendedBlock b,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> allowLazyPersist)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> (AutoCloseableLock lock = datasetLock.acquire()) &#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="comment">// 有可能有多个临时写文件</span></span><br><span class="line">      ref = volumes.getNextVolume(storageType, storageId, b.getNumBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FsVolumeImpl v = (FsVolumeImpl) ref.getVolume();</span><br><span class="line">    <span class="comment">// create an rbw file to hold block in the designated volume</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowLazyPersist &amp;&amp; !v.isTransientStorage()) &#123;</span><br><span class="line">      datanode.getMetrics().incrRamDiskBlocksWriteFallback();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ReplicaInPipeline newReplicaInfo;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 创建输出流的临时写文件 </span></span><br><span class="line">      newReplicaInfo = v.createRbw(b);</span><br><span class="line">      <span class="keyword">if</span> (newReplicaInfo.getReplicaInfo().getState() != ReplicaState.RBW) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"CreateRBW returned a replica of state "</span></span><br><span class="line">            + newReplicaInfo.getReplicaInfo().getState()</span><br><span class="line">            + <span class="string">" for block "</span> + b.getBlockId());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      IOUtils.cleanup(<span class="keyword">null</span>, ref);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volumeMap.add(b.getBlockPoolId(), newReplicaInfo.getReplicaInfo());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReplicaHandler(newReplicaInfo, ref);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReplicaInPipeline <span class="title">createRbw</span><span class="params">(ExtendedBlock b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  File f = createRbwFile(b.getBlockPoolId(), b.getLocalBlock());</span><br><span class="line">  LocalReplicaInPipeline newReplicaInfo = <span class="keyword">new</span> ReplicaBuilder(ReplicaState.RBW)</span><br><span class="line">      .setBlockId(b.getBlockId())</span><br><span class="line">      .setGenerationStamp(b.getGenerationStamp())</span><br><span class="line">      .setFsVolume(<span class="keyword">this</span>)</span><br><span class="line">      .setDirectoryToUse(f.getParentFile())</span><br><span class="line">      .setBytesToReserve(b.getNumBytes())</span><br><span class="line">      .buildLocalReplicaInPipeline();</span><br><span class="line">  <span class="keyword">return</span> newReplicaInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-5-客户端接收DN写数据应答Response"><a href="#3-1-5-客户端接收DN写数据应答Response" class="headerlink" title="3.1.5 客户端接收DN写数据应答Response"></a>3.1.5 客户端接收DN写数据应答Response</h3><p>Ctrl + n全局查找DataStreamer，搜索run方法</p>
<p>DataStreamer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">long</span> lastPacket = Time.monotonicNow();</span><br><span class="line">	TraceScope scope = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">while</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">	  <span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line">	  <span class="keyword">if</span> (errorState.hasError()) &#123;</span><br><span class="line">		closeResponder();</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  DFSPacket one;</span><br><span class="line">	  <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// process datanode IO errors if any</span></span><br><span class="line">		<span class="keyword">boolean</span> doSleep = processDatanodeOrExternalError();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> halfSocketTimeout = dfsClient.getConf().getSocketTimeout()/<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">		  <span class="comment">// wait for a packet to be sent.</span></span><br><span class="line">		  <span class="keyword">long</span> now = Time.monotonicNow();</span><br><span class="line">		  <span class="keyword">while</span> ((!shouldStop() &amp;&amp; dataQueue.size() == <span class="number">0</span> &amp;&amp;</span><br><span class="line">			  (stage != BlockConstructionStage.DATA_STREAMING ||</span><br><span class="line">				  now - lastPacket &lt; halfSocketTimeout)) || doSleep) &#123;</span><br><span class="line">			<span class="keyword">long</span> timeout = halfSocketTimeout - (now-lastPacket);</span><br><span class="line">			timeout = timeout &lt;= <span class="number">0</span> ? <span class="number">1000</span> : timeout;</span><br><span class="line">			timeout = (stage == BlockConstructionStage.DATA_STREAMING)?</span><br><span class="line">				timeout : <span class="number">1000</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			  <span class="comment">// 如果dataQueue里面没有数据，代码会阻塞在这儿</span></span><br><span class="line">			  dataQueue.wait(timeout); <span class="comment">// 接收到notify消息</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">			  LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			doSleep = <span class="keyword">false</span>;</span><br><span class="line">			now = Time.monotonicNow();</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="keyword">if</span> (shouldStop()) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="comment">// get packet to be sent.</span></span><br><span class="line">		  <span class="keyword">if</span> (dataQueue.isEmpty()) &#123;</span><br><span class="line">			one = createHeartbeatPacket();</span><br><span class="line">		  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">			  backOffIfNecessary();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			  LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//  队列不为空，从队列中取出packet</span></span><br><span class="line">			one = dataQueue.getFirst(); <span class="comment">// regular data packet</span></span><br><span class="line">			SpanId[] parents = one.getTraceParents();</span><br><span class="line">			<span class="keyword">if</span> (parents.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			  scope = dfsClient.getTracer().</span><br><span class="line">				  newScope(<span class="string">"dataStreamer"</span>, parents[<span class="number">0</span>]);</span><br><span class="line">			  scope.getSpan().setParents(parents);</span><br><span class="line">			&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get new block from namenode.</span></span><br><span class="line">		<span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">		  LOG.debug(<span class="string">"stage="</span> + stage + <span class="string">", "</span> + <span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_CREATE) &#123;</span><br><span class="line">		  LOG.debug(<span class="string">"Allocating new block: &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">		  <span class="comment">// 步骤一：向NameNode 申请block 并建立数据管道</span></span><br><span class="line">		  setPipeline(nextBlockOutputStream());</span><br><span class="line">		  <span class="comment">// 步骤二：启动ResponseProcessor用来监听packet发送是否成功</span></span><br><span class="line">		  initDataStreaming();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_APPEND) &#123;</span><br><span class="line">		  LOG.debug(<span class="string">"Append to block &#123;&#125;"</span>, block);</span><br><span class="line">		  setupPipelineForAppendOrRecovery();</span><br><span class="line">		  <span class="keyword">if</span> (streamerClosed) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">		  initDataStreaming();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> lastByteOffsetInBlock = one.getLastByteOffsetBlock();</span><br><span class="line">		<span class="keyword">if</span> (lastByteOffsetInBlock &gt; stat.getBlockSize()) &#123;</span><br><span class="line">		  <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"BlockSize "</span> + stat.getBlockSize() +</span><br><span class="line">			  <span class="string">" &lt; lastByteOffsetInBlock, "</span> + <span class="keyword">this</span> + <span class="string">", "</span> + one);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (one.isLastPacketInBlock()) &#123;</span><br><span class="line">		  <span class="comment">// wait for all data packets have been successfully acked</span></span><br><span class="line">		  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">			<span class="keyword">while</span> (!shouldStop() &amp;&amp; ackQueue.size() != <span class="number">0</span>) &#123;</span><br><span class="line">			  <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// wait for acks to arrive from datanodes</span></span><br><span class="line">				dataQueue.wait(<span class="number">1000</span>);</span><br><span class="line">			  &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">				LOG.warn(<span class="string">"Caught exception"</span>, e);</span><br><span class="line">			  &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="keyword">if</span> (shouldStop()) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">		  stage = BlockConstructionStage.PIPELINE_CLOSE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// send the packet</span></span><br><span class="line">		SpanId spanId = SpanId.INVALID;</span><br><span class="line">		<span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line"></span><br><span class="line">		  <span class="comment">// move packet from dataQueue to ackQueue</span></span><br><span class="line">		  <span class="keyword">if</span> (!one.isHeartbeatPacket()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">			  spanId = scope.getSpanId();</span><br><span class="line">			  scope.detach();</span><br><span class="line"></span><br><span class="line">			  one.setTraceScope(scope);</span><br><span class="line">			&#125;</span><br><span class="line">			scope = <span class="keyword">null</span>;</span><br><span class="line">			<span class="comment">// 步骤三：从dataQueue 把要发送的这个packet 移除出去</span></span><br><span class="line">			dataQueue.removeFirst();</span><br><span class="line">			<span class="comment">// 步骤四：然后往ackQueue 里面添加这个packet</span></span><br><span class="line">			ackQueue.addLast(one);</span><br><span class="line">			packetSendTime.put(one.getSeqno(), Time.monotonicNow());</span><br><span class="line">			dataQueue.notifyAll();</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		LOG.debug(<span class="string">"&#123;&#125; sending &#123;&#125;"</span>, <span class="keyword">this</span>, one);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// write out data to remote datanode</span></span><br><span class="line">		<span class="keyword">try</span> (TraceScope ignored = dfsClient.getTracer().</span><br><span class="line">			newScope(<span class="string">"DataStreamer#writeTo"</span>, spanId)) &#123;</span><br><span class="line">		  <span class="comment">//  将数据写出去</span></span><br><span class="line">		  one.writeTo(blockStream);</span><br><span class="line">		  blockStream.flush();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		  errorState.markFirstNodeIfNotMarked();</span><br><span class="line">		  <span class="keyword">throw</span> e;</span><br><span class="line">		&#125;</span><br><span class="line">		lastPacket = Time.monotonicNow();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// update bytesSent</span></span><br><span class="line">		<span class="keyword">long</span> tmpBytesSent = one.getLastByteOffsetBlock();</span><br><span class="line">		<span class="keyword">if</span> (bytesSent &lt; tmpBytesSent) &#123;</span><br><span class="line">		  bytesSent = tmpBytesSent;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (shouldStop()) &#123;</span><br><span class="line">		  <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Is this block full?</span></span><br><span class="line">		<span class="keyword">if</span> (one.isLastPacketInBlock()) &#123;</span><br><span class="line">		  <span class="comment">// wait for the close packet has been acked</span></span><br><span class="line">		  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">			<span class="keyword">while</span> (!shouldStop() &amp;&amp; ackQueue.size() != <span class="number">0</span>) &#123;</span><br><span class="line">			  dataQueue.wait(<span class="number">1000</span>);<span class="comment">// wait for acks to arrive from datanodes</span></span><br><span class="line">			&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">		  <span class="keyword">if</span> (shouldStop()) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		  &#125;</span><br><span class="line"></span><br><span class="line">		  endBlock();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (progress != <span class="keyword">null</span>) &#123; progress.progress(); &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This is used by unit test to trigger race conditions.</span></span><br><span class="line">		<span class="keyword">if</span> (artificialSlowdown != <span class="number">0</span> &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">		  Thread.sleep(artificialSlowdown);</span><br><span class="line">		&#125;</span><br><span class="line">	  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">		... ...</span><br><span class="line">	  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (scope != <span class="keyword">null</span>) &#123;</span><br><span class="line">		  scope.close();</span><br><span class="line">		  scope = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	closeInternal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDataStreaming</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.setName(<span class="string">"DataStreamer for file "</span> + src +</span><br><span class="line">      <span class="string">" block "</span> + block);</span><br><span class="line">  ... ...</span><br><span class="line">  response = <span class="keyword">new</span> ResponseProcessor(nodes);</span><br><span class="line">  response.start();</span><br><span class="line">  stage = BlockConstructionStage.DATA_STREAMING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击response再点击ResponseProcessor，ctrl + f 查找run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">	ackQueue.removeFirst();</span><br><span class="line">	packetSendTime.remove(seqno);</span><br><span class="line">	dataQueue.notifyAll();</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第4章-Yarn源码解析"><a href="#第4章-Yarn源码解析" class="headerlink" title="第4章 Yarn源码解析"></a>第4章 Yarn源码解析</h1><p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808170544341.png" alt="image-20220808170544341"></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808170600803.png" alt="image-20220808170600803"></p>
<h2 id="4-1-Yarn客户端向RM提交作业"><a href="#4-1-Yarn客户端向RM提交作业" class="headerlink" title="4.1 Yarn客户端向RM提交作业"></a>4.1 Yarn客户端向RM提交作业</h2><p><strong>1）在wordcount程序的驱动类中点击</strong></p>
<p>Job.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> result = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">waitForCompletion</span><span class="params">(<span class="keyword">boolean</span> verbose</span></span></span><br><span class="line"><span class="function"><span class="params">                                 )</span> <span class="keyword">throws</span> IOException, InterruptedException,</span></span><br><span class="line"><span class="function">                                          ClassNotFoundException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (state == JobState.DEFINE) &#123;</span><br><span class="line">    submit();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">    monitorAndPrintJob();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// get the completion poll interval from the client.</span></span><br><span class="line">    <span class="keyword">int</span> completionPollIntervalMillis = </span><br><span class="line">      Job.getCompletionPollInterval(cluster.getConf());</span><br><span class="line">    <span class="keyword">while</span> (!isComplete()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(completionPollIntervalMillis);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> isSuccessful();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> IOException, InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">  ensureState(JobState.DEFINE);</span><br><span class="line">  setUseNewAPI();</span><br><span class="line">  connect();</span><br><span class="line">  <span class="keyword">final</span> JobSubmitter submitter = </span><br><span class="line">      getJobSubmitter(cluster.getFileSystem(), cluster.getClient());</span><br><span class="line">  status = ugi.doAs(<span class="keyword">new</span> PrivilegedExceptionAction&lt;JobStatus&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobStatus <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, </span></span><br><span class="line"><span class="function">    ClassNotFoundException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> submitter.submitJobInternal(Job.<span class="keyword">this</span>, cluster);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  state = JobState.RUNNING;</span><br><span class="line">  LOG.info(<span class="string">"The url to track the job: "</span> + getTrackingURL());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>点击submitJobInternal()</p>
<p>JobSubmitter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JobStatus <span class="title">submitJobInternal</span><span class="params">(Job job, Cluster cluster)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> ClassNotFoundException, InterruptedException, IOException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  status = submitClient.submitJob(</span><br><span class="line">          jobId, submitJobDir.toString(), job.getCredentials()); </span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">submitJob</span><span class="params">(JobID jobId, String jobSubmitDir, Credentials ts)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br></pre></td></tr></table></figure>

<p><strong>2）创建提交环境</strong></p>
<p>ctrl + alt +B 查找submitJob实现类，YARNRunner.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">submitJob</span><span class="params">(JobID jobId, String jobSubmitDir, Credentials ts)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  addHistoryToken(ts);</span><br><span class="line">  <span class="comment">// 创建提交环境：</span></span><br><span class="line">  ApplicationSubmissionContext appContext =</span><br><span class="line">    createApplicationSubmissionContext(conf, jobSubmitDir, ts);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Submit to ResourceManager</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 向RM提交一个应用程序，appContext里面封装了启动mrappMaster和运行container的命令</span></span><br><span class="line">    ApplicationId applicationId =</span><br><span class="line">        resMgrDelegate.submitApplication(appContext);</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 获取提交响应</span></span><br><span class="line">    ApplicationReport appMaster = resMgrDelegate</span><br><span class="line">        .getApplicationReport(applicationId);</span><br><span class="line">		</span><br><span class="line">    String diagnostics =</span><br><span class="line">        (appMaster == <span class="keyword">null</span> ?</span><br><span class="line">            <span class="string">"application report is null"</span> : appMaster.getDiagnostics());</span><br><span class="line">    <span class="keyword">if</span> (appMaster == <span class="keyword">null</span></span><br><span class="line">        || appMaster.getYarnApplicationState() == YarnApplicationState.FAILED</span><br><span class="line">        || appMaster.getYarnApplicationState() == YarnApplicationState.KILLED) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to run job : "</span> +</span><br><span class="line">          diagnostics);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clientCache.getClient(jobId).getJobStatus(jobId);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (YarnException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ApplicationSubmissionContext <span class="title">createApplicationSubmissionContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Configuration jobConf, String jobSubmitDir, Credentials ts)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ApplicationId applicationId = resMgrDelegate.getApplicationId();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup LocalResources</span></span><br><span class="line">  <span class="comment">// 封装了本地资源相关路径</span></span><br><span class="line">  Map&lt;String, LocalResource&gt; localResources =</span><br><span class="line">      setupLocalResources(jobConf, jobSubmitDir);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup security tokens</span></span><br><span class="line">  DataOutputBuffer dob = <span class="keyword">new</span> DataOutputBuffer();</span><br><span class="line">  ts.writeTokenStorageToStream(dob);</span><br><span class="line">  ByteBuffer securityTokens =</span><br><span class="line">      ByteBuffer.wrap(dob.getData(), <span class="number">0</span>, dob.getLength());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup ContainerLaunchContext for AM container</span></span><br><span class="line">  <span class="comment">// 封装了启动mrappMaster和运行container的命令</span></span><br><span class="line">  List&lt;String&gt; vargs = setupAMCommand(jobConf);</span><br><span class="line">  ContainerLaunchContext amContainer = setupContainerLaunchContextForAM(</span><br><span class="line">      jobConf, localResources, securityTokens, vargs);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> appContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">setupAMCommand</span><span class="params">(Configuration jobConf)</span> </span>&#123;</span><br><span class="line">  List&lt;String&gt; vargs = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">  <span class="comment">// Java进程启动命令开始</span></span><br><span class="line">  vargs.add(MRApps.crossPlatformifyMREnv(jobConf, Environment.JAVA_HOME)</span><br><span class="line">      + <span class="string">"/bin/java"</span>);</span><br><span class="line"></span><br><span class="line">  Path amTmpDir =</span><br><span class="line">      <span class="keyword">new</span> Path(MRApps.crossPlatformifyMREnv(conf, Environment.PWD),</span><br><span class="line">          YarnConfiguration.DEFAULT_CONTAINER_TEMP_DIR);</span><br><span class="line">  vargs.add(<span class="string">"-Djava.io.tmpdir="</span> + amTmpDir);</span><br><span class="line">  MRApps.addLog4jSystemProperties(<span class="keyword">null</span>, vargs, conf);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check for Java Lib Path usage in MAP and REDUCE configs</span></span><br><span class="line">  warnForJavaLibPath(conf.get(MRJobConfig.MAP_JAVA_OPTS, <span class="string">""</span>),</span><br><span class="line">      <span class="string">"map"</span>,</span><br><span class="line">      MRJobConfig.MAP_JAVA_OPTS,</span><br><span class="line">      MRJobConfig.MAP_ENV);</span><br><span class="line">  warnForJavaLibPath(conf.get(MRJobConfig.MAPRED_MAP_ADMIN_JAVA_OPTS, <span class="string">""</span>),</span><br><span class="line">      <span class="string">"map"</span>,</span><br><span class="line">      MRJobConfig.MAPRED_MAP_ADMIN_JAVA_OPTS,</span><br><span class="line">      MRJobConfig.MAPRED_ADMIN_USER_ENV);</span><br><span class="line">  warnForJavaLibPath(conf.get(MRJobConfig.REDUCE_JAVA_OPTS, <span class="string">""</span>),</span><br><span class="line">      <span class="string">"reduce"</span>,</span><br><span class="line">      MRJobConfig.REDUCE_JAVA_OPTS,</span><br><span class="line">      MRJobConfig.REDUCE_ENV);</span><br><span class="line">  warnForJavaLibPath(conf.get(MRJobConfig.MAPRED_REDUCE_ADMIN_JAVA_OPTS, <span class="string">""</span>),</span><br><span class="line">      <span class="string">"reduce"</span>,</span><br><span class="line">      MRJobConfig.MAPRED_REDUCE_ADMIN_JAVA_OPTS,</span><br><span class="line">      MRJobConfig.MAPRED_ADMIN_USER_ENV);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add AM admin command opts before user command opts</span></span><br><span class="line">  <span class="comment">// so that it can be overridden by user</span></span><br><span class="line">  String mrAppMasterAdminOptions = conf.get(MRJobConfig.MR_AM_ADMIN_COMMAND_OPTS,</span><br><span class="line">      MRJobConfig.DEFAULT_MR_AM_ADMIN_COMMAND_OPTS);</span><br><span class="line">  warnForJavaLibPath(mrAppMasterAdminOptions, <span class="string">"app master"</span>,</span><br><span class="line">      MRJobConfig.MR_AM_ADMIN_COMMAND_OPTS, MRJobConfig.MR_AM_ADMIN_USER_ENV);</span><br><span class="line">  vargs.add(mrAppMasterAdminOptions);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add AM user command opts 用户命令参数</span></span><br><span class="line">  String mrAppMasterUserOptions = conf.get(MRJobConfig.MR_AM_COMMAND_OPTS,</span><br><span class="line">      MRJobConfig.DEFAULT_MR_AM_COMMAND_OPTS);</span><br><span class="line">  warnForJavaLibPath(mrAppMasterUserOptions, <span class="string">"app master"</span>,</span><br><span class="line">      MRJobConfig.MR_AM_COMMAND_OPTS, MRJobConfig.MR_AM_ENV);</span><br><span class="line">  vargs.add(mrAppMasterUserOptions);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (jobConf.getBoolean(MRJobConfig.MR_AM_PROFILE,</span><br><span class="line">      MRJobConfig.DEFAULT_MR_AM_PROFILE)) &#123;</span><br><span class="line">    <span class="keyword">final</span> String profileParams = jobConf.get(MRJobConfig.MR_AM_PROFILE_PARAMS,</span><br><span class="line">        MRJobConfig.DEFAULT_TASK_PROFILE_PARAMS);</span><br><span class="line">    <span class="keyword">if</span> (profileParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">      vargs.add(String.format(profileParams,</span><br><span class="line">          ApplicationConstants.LOG_DIR_EXPANSION_VAR + Path.SEPARATOR</span><br><span class="line">              + TaskLog.LogName.PROFILE));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装了要启动的mrappmaster全类名 </span></span><br><span class="line">  <span class="comment">// org.apache.hadoop.mapreduce.v2.app.MRAppMaster</span></span><br><span class="line">  vargs.add(MRJobConfig.APPLICATION_MASTER_CLASS);</span><br><span class="line">  vargs.add(<span class="string">"1&gt;"</span> + ApplicationConstants.LOG_DIR_EXPANSION_VAR +</span><br><span class="line">      Path.SEPARATOR + ApplicationConstants.STDOUT);</span><br><span class="line">  vargs.add(<span class="string">"2&gt;"</span> + ApplicationConstants.LOG_DIR_EXPANSION_VAR +</span><br><span class="line">      Path.SEPARATOR + ApplicationConstants.STDERR);</span><br><span class="line">  <span class="keyword">return</span> vargs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3）向Yarn提交</strong></p>
<p>点击submitJob方法中的submitApplication()</p>
<p>YARNRunner.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ApplicationId applicationId = </span><br><span class="line">resMgrDelegate.submitApplication(appContext);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ApplicationId</span><br><span class="line">    submitApplication(ApplicationSubmissionContext appContext)</span><br><span class="line">        <span class="keyword">throws</span> YarnException, IOException &#123;</span><br><span class="line">  <span class="keyword">return</span> client.submitApplication(appContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + alt +B 查找submitApplication实现类，YarnClientImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ApplicationId</span><br><span class="line">    submitApplication(ApplicationSubmissionContext appContext)</span><br><span class="line">        <span class="keyword">throws</span> YarnException, IOException &#123;</span><br><span class="line">  ApplicationId applicationId = appContext.getApplicationId();</span><br><span class="line">  <span class="keyword">if</span> (applicationId == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationIdNotProvidedException(</span><br><span class="line">        <span class="string">"ApplicationId is not provided in ApplicationSubmissionContext"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建一个提交请求</span></span><br><span class="line">  SubmitApplicationRequest request =</span><br><span class="line">      Records.newRecord(SubmitApplicationRequest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  request.setApplicationSubmissionContext(appContext);</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//<span class="doctag">TODO:</span> YARN-1763:Handle RM failovers during the submitApplication call.</span></span><br><span class="line">  <span class="comment">// 继续提交，实现类是ApplicationClientProtocolPBClientImpl</span></span><br><span class="line">  rmClient.submitApplication(request);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> pollCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">  EnumSet&lt;YarnApplicationState&gt; waitingStates = </span><br><span class="line">                               EnumSet.of(YarnApplicationState.NEW,</span><br><span class="line">                               YarnApplicationState.NEW_SAVING,</span><br><span class="line">                               YarnApplicationState.SUBMITTED);</span><br><span class="line">  EnumSet&lt;YarnApplicationState&gt; failToSubmitStates = </span><br><span class="line">                                EnumSet.of(YarnApplicationState.FAILED,</span><br><span class="line">                                YarnApplicationState.KILLED);		</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 获取提交给Yarn的反馈</span></span><br><span class="line">      ApplicationReport appReport = getApplicationReport(applicationId);</span><br><span class="line">      YarnApplicationState state = appReport.getYarnApplicationState();</span><br><span class="line">      ... ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ApplicationNotFoundException ex) &#123;</span><br><span class="line">      <span class="comment">// FailOver or RM restart happens before RMStateStore saves</span></span><br><span class="line">      <span class="comment">// ApplicationState</span></span><br><span class="line">      LOG.info(<span class="string">"Re-submit application "</span> + applicationId + <span class="string">"with the "</span> +</span><br><span class="line">          <span class="string">"same ApplicationSubmissionContext"</span>);</span><br><span class="line">	  <span class="comment">// 如果提交失败，则再次提交</span></span><br><span class="line">      rmClient.submitApplication(request);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> applicationId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + alt +B 查找submitApplication实现类，ClientRMService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SubmitApplicationResponse <span class="title">submitApplication</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    SubmitApplicationRequest request)</span> <span class="keyword">throws</span> YarnException, IOException </span>&#123;</span><br><span class="line">  ApplicationSubmissionContext submissionContext = request</span><br><span class="line">      .getApplicationSubmissionContext();</span><br><span class="line">  ApplicationId applicationId = submissionContext.getApplicationId();</span><br><span class="line">  CallerContext callerContext = CallerContext.getCurrent();</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// call RMAppManager to submit application directly</span></span><br><span class="line">    rmAppManager.submitApplication(submissionContext,</span><br><span class="line">        System.currentTimeMillis(), user);</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">"Application with id "</span> + applicationId.getId() + </span><br><span class="line">        <span class="string">" submitted by user "</span> + user);</span><br><span class="line">    RMAuditLogger.logSuccess(user, AuditConstants.SUBMIT_APP_REQUEST,</span><br><span class="line">        <span class="string">"ClientRMService"</span>, applicationId, callerContext,</span><br><span class="line">        submissionContext.getQueue());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (YarnException e) &#123;</span><br><span class="line">    LOG.info(<span class="string">"Exception in submitting "</span> + applicationId, e);</span><br><span class="line">    RMAuditLogger.logFailure(user, AuditConstants.SUBMIT_APP_REQUEST,</span><br><span class="line">        e.getMessage(), <span class="string">"ClientRMService"</span>,</span><br><span class="line">        <span class="string">"Exception in submitting application"</span>, applicationId, callerContext,</span><br><span class="line">        submissionContext.getQueue());</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> recordFactory</span><br><span class="line">      .newRecordInstance(SubmitApplicationResponse<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-RM启动MRAppMaster"><a href="#4-2-RM启动MRAppMaster" class="headerlink" title="4.2 RM启动MRAppMaster"></a>4.2 RM启动MRAppMaster</h2><p><strong>0）在pom.xml中增加如下依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ctrl +n 查找MRAppMaster，搜索main方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化一个container</span></span><br><span class="line">    ContainerId containerId = ContainerId.fromString(containerIdStr);</span><br><span class="line">    ApplicationAttemptId applicationAttemptId =</span><br><span class="line">        containerId.getApplicationAttemptId();</span><br><span class="line">    <span class="keyword">if</span> (applicationAttemptId != <span class="keyword">null</span>) &#123;</span><br><span class="line">      CallerContext.setCurrent(<span class="keyword">new</span> CallerContext.Builder(</span><br><span class="line">          <span class="string">"mr_appmaster_"</span> + applicationAttemptId.toString()).build());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> appSubmitTime = Long.parseLong(appSubmitTimeStr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建appMaster对象</span></span><br><span class="line">    MRAppMaster appMaster =</span><br><span class="line">        <span class="keyword">new</span> MRAppMaster(applicationAttemptId, containerId, nodeHostString,</span><br><span class="line">            Integer.parseInt(nodePortString),</span><br><span class="line">            Integer.parseInt(nodeHttpPortString), appSubmitTime);</span><br><span class="line">    ... ...</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 初始化并启动AppMaster</span></span><br><span class="line">    initAndStartAppMaster(appMaster, conf, jobUserName);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Error starting MRAppMaster"</span>, t);</span><br><span class="line">    ExitUtil.terminate(<span class="number">1</span>, t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initAndStartAppMaster</span><span class="params">(<span class="keyword">final</span> MRAppMaster appMaster,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> JobConf conf, String jobUserName)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    InterruptedException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  conf.getCredentials().addAll(credentials);</span><br><span class="line">  appMasterUgi.doAs(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	  <span class="comment">// 初始化</span></span><br><span class="line">      appMaster.init(conf);</span><br><span class="line">	  <span class="comment">// 启动</span></span><br><span class="line">      appMaster.start();</span><br><span class="line">      <span class="keyword">if</span>(appMaster.errorHappenedShutDown) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Was asked to shut down."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">synchronized</span> (stateChangeLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enterState(STATE.INITED) != STATE.INITED) &#123;</span><br><span class="line">      setConfig(conf);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">// 调用MRAppMaster中的serviceInit()方法</span></span><br><span class="line">        serviceInit(config);</span><br><span class="line">        <span class="keyword">if</span> (isInState(STATE.INITED)) &#123;</span><br><span class="line">          <span class="comment">//if the service ended up here during init,</span></span><br><span class="line">          <span class="comment">//notify the listeners</span></span><br><span class="line">		  <span class="comment">// 如果初始化完成，通知监听器</span></span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        noteFailure(e);</span><br><span class="line">        ServiceOperations.stopQuietly(LOG, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">throw</span> ServiceStateException.convert(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + alt +B 查找serviceInit实现类，MRAppMaster.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceInit</span><span class="params">(<span class="keyword">final</span> Configuration conf)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="comment">// 创建提交路径</span></span><br><span class="line">  clientService = createClientService(context);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建调度器</span></span><br><span class="line">  clientService.init(conf);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建job提交RPC客户端</span></span><br><span class="line">  containerAllocator = createContainerAllocator(clientService, context);</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击MRAppMaster.java 中的initAndStartAppMaster 方法中的appMaster.start();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isInState(STATE.STARTED)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//enter the started state</span></span><br><span class="line">  <span class="keyword">synchronized</span> (stateChangeLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stateModel.enterState(STATE.STARTED) != STATE.STARTED) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// 调用MRAppMaster中的serviceStart()方法</span></span><br><span class="line">        serviceStart();</span><br><span class="line">        <span class="keyword">if</span> (isInState(STATE.STARTED)) &#123;</span><br><span class="line">          <span class="comment">//if the service started (and isn't now in a later state), notify</span></span><br><span class="line">          LOG.debug(<span class="string">"Service &#123;&#125; is started"</span>, getName());</span><br><span class="line">          notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        noteFailure(e);</span><br><span class="line">        ServiceOperations.stopQuietly(LOG, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">throw</span> ServiceStateException.convert(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (initFailed) &#123;</span><br><span class="line">    JobEvent initFailedEvent = <span class="keyword">new</span> JobEvent(job.getID(), JobEventType.JOB_INIT_FAILED);</span><br><span class="line">    jobEventDispatcher.handle(initFailedEvent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// All components have started, start the job.</span></span><br><span class="line">	<span class="comment">// 初始化成功后，提交Job到队列中</span></span><br><span class="line">    startJobs();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startJobs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  / create a job-start event to get <span class="keyword">this</span> ball rolling */</span><br><span class="line">  JobEvent startJobEvent = <span class="keyword">new</span> JobStartEvent(job.getID(),</span><br><span class="line">      recoveredJobStartTime);</span><br><span class="line">  / send the job-start event. <span class="keyword">this</span> triggers the job execution. */</span><br><span class="line">  <span class="comment">// 这里将job存放到yarn队列</span></span><br><span class="line">  <span class="comment">// dispatcher = AsyncDispatcher</span></span><br><span class="line">  <span class="comment">// getEventHandler()返回的是GenericEventHandler</span></span><br><span class="line">  dispatcher.getEventHandler().handle(startJobEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + alt +B 查找handle实现类，GenericEventHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericEventHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">	  <span class="comment">// 将job存储到yarn队列中</span></span><br><span class="line">      eventQueue.put(event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      ... ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-调度器任务执行（YarnChild）"><a href="#4-3-调度器任务执行（YarnChild）" class="headerlink" title="4.3 调度器任务执行（YarnChild）"></a>4.3 调度器任务执行（YarnChild）</h2><p><strong>1）启动MapTask</strong></p>
<p>ctrl +n 查找YarnChild，搜索main方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> YarnUncaughtExceptionHandler());</span><br><span class="line">  LOG.debug(<span class="string">"Child starting"</span>);</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  task = myTask.getTask();</span><br><span class="line">  YarnChild.taskid = task.getTaskID();</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a final reference to the task for the doAs block</span></span><br><span class="line">  <span class="keyword">final</span> Task taskFinal = task;</span><br><span class="line">  childUGI.doAs(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// use job-specified working directory</span></span><br><span class="line">        setEncryptedSpillKeyIfRequired(taskFinal);</span><br><span class="line">        FileSystem.get(job).setWorkingDirectory(job.getWorkingDirectory());</span><br><span class="line">		<span class="comment">// 调用task执行（maptask或者reducetask）</span></span><br><span class="line">        taskFinal.run(job, umbilical); <span class="comment">// run the task</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; </span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ctrl + alt +B 查找run实现类，maptask.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> JobConf job, <span class="keyword">final</span> TaskUmbilicalProtocol umbilical)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.umbilical = umbilical;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是MapTask</span></span><br><span class="line">  <span class="keyword">if</span> (isMapTask()) &#123;</span><br><span class="line">    <span class="comment">// If there are no reducers then there won't be any sort. Hence the map </span></span><br><span class="line">    <span class="comment">// phase will govern the entire attempt's progress.</span></span><br><span class="line">	<span class="comment">// 如果reducetask个数为零，maptask占用整个任务的100%</span></span><br><span class="line">    <span class="keyword">if</span> (conf.getNumReduceTasks() == <span class="number">0</span>) &#123;</span><br><span class="line">      mapPhase = getProgress().addPhase(<span class="string">"map"</span>, <span class="number">1.0f</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If there are reducers then the entire attempt's progress will be </span></span><br><span class="line">      <span class="comment">// split between the map phase (67%) and the sort phase (33%).</span></span><br><span class="line">	  <span class="comment">// 如果reduceTask个数不为零，MapTask占用整个任务的66.7% sort阶段占比</span></span><br><span class="line">      mapPhase = getProgress().addPhase(<span class="string">"map"</span>, <span class="number">0.667f</span>);</span><br><span class="line">      sortPhase  = getProgress().addPhase(<span class="string">"sort"</span>, <span class="number">0.333f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (useNewApi) &#123;</span><br><span class="line">    <span class="comment">// 调用新的API执行maptask</span></span><br><span class="line">    runNewMapper(job, splitMetaInfo, umbilical, reporter);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    runOldMapper(job, splitMetaInfo, umbilical, reporter);</span><br><span class="line">  &#125;</span><br><span class="line">  done(umbilical, reporter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNewMapper</span><span class="params">(<span class="keyword">final</span> JobConf job,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">final</span> TaskSplitIndex splitIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span></span></span><br><span class="line"><span class="function"><span class="params">                  TaskReporter reporter</span></span></span><br><span class="line"><span class="function"><span class="params">                  )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">                           InterruptedException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    input.initialize(split, mapperContext);</span><br><span class="line">	<span class="comment">// 运行maptask</span></span><br><span class="line">    mapper.run(mapperContext);</span><br><span class="line">	</span><br><span class="line">    mapPhase.complete();</span><br><span class="line">    setPhase(TaskStatus.Phase.SORT);</span><br><span class="line">    statusUpdate(umbilical);</span><br><span class="line">    input.close();</span><br><span class="line">    input = <span class="keyword">null</span>;</span><br><span class="line">    output.close(mapperContext);</span><br><span class="line">    output = <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    closeQuietly(input);</span><br><span class="line">    closeQuietly(output, mapperContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mapper.java（和Map联系在一起）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  setup(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (context.nextKeyValue()) &#123;</span><br><span class="line">      map(context.getCurrentKey(), context.getCurrentValue(), context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    cleanup(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）启动ReduceTask</strong></p>
<p>在YarnChild.java类中的main方法中ctrl + alt +B 查找run实现类，reducetask.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(JobConf job, <span class="keyword">final</span> TaskUmbilicalProtocol umbilical)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">  job.setBoolean(JobContext.SKIP_RECORDS, isSkipping());</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useNewApi) &#123;</span><br><span class="line">	<span class="comment">// 调用新API执行reduce</span></span><br><span class="line">    runNewReducer(job, umbilical, reporter, rIter, comparator, </span><br><span class="line">                  keyClass, valueClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    runOldReducer(job, umbilical, reporter, rIter, comparator, </span><br><span class="line">                  keyClass, valueClass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  shuffleConsumerPlugin.close();</span><br><span class="line">  done(umbilical, reporter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNewReducer</span><span class="params">(JobConf job,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">final</span> TaskReporter reporter,</span></span></span><br><span class="line"><span class="function"><span class="params">                   RawKeyValueIterator rIter,</span></span></span><br><span class="line"><span class="function"><span class="params">                   RawComparator&lt;INKEY&gt; comparator,</span></span></span><br><span class="line"><span class="function"><span class="params">                   Class&lt;INKEY&gt; keyClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                   Class&lt;INVALUE&gt; valueClass</span></span></span><br><span class="line"><span class="function"><span class="params">                   )</span> <span class="keyword">throws</span> IOException,InterruptedException, </span></span><br><span class="line"><span class="function">                            ClassNotFoundException </span>&#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 调用reducetask的run方法</span></span><br><span class="line">    reducer.run(reducerContext);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    trackedRW.close(reducerContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Reduce.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  setup(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (context.nextKey()) &#123;</span><br><span class="line">      reduce(context.getCurrentKey(), context.getValues(), context);</span><br><span class="line">      <span class="comment">// If a back up store is used, reset it</span></span><br><span class="line">      Iterator&lt;VALUEIN&gt; iter = context.getValues().iterator();</span><br><span class="line">      <span class="keyword">if</span>(iter <span class="keyword">instanceof</span> ReduceContext.ValueIterator) &#123;</span><br><span class="line">        ((ReduceContext.ValueIterator&lt;VALUEIN&gt;)iter).resetBackupStore();        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    cleanup(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第5章-MapReduce源码解析"><a href="#第5章-MapReduce源码解析" class="headerlink" title="第5章 MapReduce源码解析"></a>第5章 MapReduce源码解析</h1><p>说明：在MapReduce笔记中，已经记录过源码，在这就不再赘述。</p>
<h2 id="5-1-Job提交流程源码和切片源码详解"><a href="#5-1-Job提交流程源码和切片源码详解" class="headerlink" title="5.1 Job提交流程源码和切片源码详解"></a>5.1 Job提交流程源码和切片源码详解</h2><p><strong>1）Job提交流程源码详解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">waitForCompletion()</span><br><span class="line"></span><br><span class="line">submit();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1建立连接</span></span><br><span class="line">	connect();	</span><br><span class="line">		<span class="comment">// 1）创建提交Job的代理</span></span><br><span class="line">		<span class="keyword">new</span> Cluster(getConfiguration());</span><br><span class="line">			<span class="comment">// （1）判断是本地运行环境还是yarn集群运行环境</span></span><br><span class="line">			initialize(jobTrackAddr, conf); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 提交job</span></span><br><span class="line">submitter.submitJobInternal(Job.<span class="keyword">this</span>, cluster)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1）创建给集群提交数据的Stag路径</span></span><br><span class="line">	Path jobStagingArea = JobSubmissionFiles.getStagingDir(cluster, conf);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2）获取jobid ，并创建Job路径</span></span><br><span class="line">	JobID jobId = submitClient.getNewJobID();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3）拷贝jar包到集群</span></span><br><span class="line">copyAndConfigureFiles(job, submitJobDir);	</span><br><span class="line">	rUploader.uploadFiles(job, jobSubmitDir);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4）计算切片，生成切片规划文件</span></span><br><span class="line">writeSplits(job, submitJobDir);</span><br><span class="line">		maps = writeNewSplits(job, jobSubmitDir);</span><br><span class="line">		input.getSplits(job);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 5）向Stag路径写XML配置文件</span></span><br><span class="line">writeConf(conf, submitJobFile);</span><br><span class="line">	conf.writeXml(out);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 6）提交Job,返回提交状态</span></span><br><span class="line">status = submitClient.submitJob(jobId, submitJobDir.toString(), job.getCredentials());</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171345335.png" alt="image-20220808171345335"></p>
<p>2）FileInputFormat切片源码解析（input.getSplits(job)）</p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171431731.png" alt="image-20220808171431731"></p>
<h2 id="5-2-MapTask-amp-ReduceTask源码解析"><a href="#5-2-MapTask-amp-ReduceTask源码解析" class="headerlink" title="5.2 MapTask &amp; ReduceTask源码解析"></a>5.2 MapTask &amp; ReduceTask源码解析</h2><p>1）MapTask源码解析流程</p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171608932.png" alt="image-20220808171608932"></p>
<p>2）ReduceTask源码解析流程</p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171631745.png" alt="image-20220808171631745"></p>
<h1 id="第6章-Hadoop源码编译"><a href="#第6章-Hadoop源码编译" class="headerlink" title="第6章 Hadoop源码编译"></a>第6章 Hadoop源码编译</h1><h2 id="6-1-前期准备工作"><a href="#6-1-前期准备工作" class="headerlink" title="6.1 前期准备工作"></a>6.1 前期准备工作</h2><p><strong>1）官网下载源码</strong></p>
<p><a href="https://hadoop.apache.org/release/3.1.3.html" target="_blank" rel="noopener">https://hadoop.apache.org/release/3.1.3.html</a></p>
<p><strong>2）修改源码中的HDFS副本数的设置</strong></p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808171654094.png" alt="image-20220808171654094"></p>
<p><strong>3）CentOS虚拟机准备</strong></p>
<p>（1）CentOS联网 </p>
<p>配置CentOS能连接外网。Linux虚拟机ping <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 是畅通的</p>
<p>注意：采用root角色编译，减少文件夹权限出现问题</p>
<p>（2）Jar包准备（Hadoop源码、JDK8、Maven、Ant 、Protobuf）</p>
<p>​     1. hadoop-3.1.3-src.tar.gz</p>
<p>​     2. jdk-8u212-linux-x64.tar.gz</p>
<p>​     3. apache-maven-3.6.3-bin.tar.gz</p>
<p>​     4. protobuf-2.5.0.tar.gz（序列化的框架）</p>
<p>​     5. cmake-3.17.0.tar.gz</p>
<h2 id="6-2-工具包安装"><a href="#6-2-工具包安装" class="headerlink" title="6.2 工具包安装"></a>6.2 工具包安装</h2><p>注意：所有操作必须在root用户下完成</p>
<p><strong>0）分别创建/opt/software/hadoop_source和/opt/module/hadoop_source路径</strong></p>
<p><strong>1）上传软件包到指定的目录，例如 /opt/software/hadoop_source</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]$ pwd</span><br><span class="line">/opt/software/hadoop_source</span><br><span class="line">[root@hadoop101 hadoop_source]$ ll</span><br><span class="line">总用量 55868</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu  9506321 3月  28 13:23 apache-maven-3.6.3-bin.tar.gz</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu  8614663 3月  28 13:23 cmake-3.17.0.tar.gz</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu 29800905 3月  28 13:23 hadoop-3.1.3-src.tar.gz</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu  2401901 3月  28 13:23 protobuf-2.5.0.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>2）解压软件包指定的目录，例如： /opt/module/hadoop_source</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]$ tar -zxvf apache-maven-3.6.3-bin.tar.gz -C  /opt/module/hadoop_source/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]$ tar -zxvf cmake-3.17.0.tar.gz -C  /opt/module/hadoop_source/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]$ tar -zxvf hadoop-3.1.3-src.tar.gz -C  /opt/module/hadoop_source/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]$ tar -zxvf protobuf-2.5.0.tar.gz -C  /opt/module/hadoop_source/</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]$ pwd</span><br><span class="line">/opt/module/hadoop_source</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]$ ll</span><br><span class="line">总用量 20</span><br><span class="line">drwxrwxr-x.  6 atguigu atguigu 4096 3月  28 13:25 apache-maven-3.6.3</span><br><span class="line">drwxr-xr-x. 15 root    root    4096 3月  28 13:43 cmake-3.17.0</span><br><span class="line">drwxr-xr-x. 18 atguigu atguigu 4096 9月  12 2019 hadoop-3.1.3-src</span><br><span class="line">drwxr-xr-x. 10 atguigu atguigu 4096 3月  28 13:44 protobuf-2.5.0</span><br></pre></td></tr></table></figure>

<p><strong>3）安装JDK</strong></p>
<p>（1）解压JDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]# tar -zxvf jdk-8u212-linux-x64.tar.gz -C /opt/module/hadoop_source/</span><br></pre></td></tr></table></figure>

<p>（2）配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 jdk1.8.0_212]# vim /etc/profile.d/my_env.sh</span><br><span class="line">输入如下内容：</span><br><span class="line"><span class="meta">#</span><span class="bash">JAVA_HOME</span></span><br><span class="line">export JAVA_HOME=/opt/module/hadoop_source/jdk1.8.0_212</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br></pre></td></tr></table></figure>

<p>（3）刷新JDK环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 jdk1.8.0_212]# source /etc/profile</span><br></pre></td></tr></table></figure>

<p>（4）验证JDK是否安装成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]$ java -version</span><br><span class="line">java version "1.8.0_212"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_212-b10)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.212-b10, mixed mode)</span><br></pre></td></tr></table></figure>

<p><strong>4）配置maven环境变量，maven镜像，并验证</strong></p>
<p>（1）配置maven的环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]#  vim /etc/profile.d/my_env.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">MAVEN_HOME</span></span><br><span class="line">MAVEN_HOME=/opt/module/hadoop_source/apache-maven-3.6.3</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin</span><br><span class="line"></span><br><span class="line">[root@hadoop101 hadoop_source]#  source /etc/profile</span><br></pre></td></tr></table></figure>

<p>（2）修改maven的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 apache-maven-3.6.3]# vi conf/settings.xml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 mirrors节点中添加阿里云镜像</span></span><br><span class="line">&lt;mirrors&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">         &lt;id&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">         &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;</span><br><span class="line">         &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">                &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">&lt;/mirrors&gt;</span><br></pre></td></tr></table></figure>

<p>（3）验证maven安装是否成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop_source]# mvn -version </span><br><span class="line">Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">Maven home: /opt/module/hadoop_source/apache-maven-3.6.3</span><br><span class="line">Java version: 1.8.0_212, vendor: Oracle Corporation, runtime: /opt/module/hadoop_source/jdk1.8.0_212/jre</span><br><span class="line">Default locale: zh_CN, platform encoding: UTF-8</span><br><span class="line">OS name: "linux", version: "3.10.0-862.el7.x86_64", arch: "amd64", family: "unix"</span><br></pre></td></tr></table></figure>

<p><strong>5）安装相关的依赖(注意安装顺序不可乱，可能会出现依赖找不到问题)</strong></p>
<p>（1）安装gcc make </p>
<p><code>[root@hadoop101 hadoop_source]# yum install -y gcc* make</code></p>
<p>（2）安装压缩工具</p>
<p><code>[root@hadoop101 hadoop_source]# yum -y install snappy*  bzip2* lzo* zlib*  lz4* gzip*</code></p>
<p>（3）安装一些基本工具</p>
<p><code>[root@hadoop101 hadoop_source]# yum -y install openssl* svn ncurses* autoconf automake libtool</code></p>
<p>（4）安装扩展源，才可安装zstd</p>
<p><code>[root@hadoop101 hadoop_source]# yum -y install epel-release</code></p>
<p>（5）安装zstd</p>
<p><code>[root@hadoop101 hadoop_source]# yum -y install *zstd*</code></p>
<p><strong>6）手动安装cmake</strong></p>
<p>（1）在解压好的cmake目录下，执行./bootstrap进行编译，此过程需一小时请耐心等待</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 cmake-3.17.0]$ pwd</span><br><span class="line">/opt/module/hadoop_source/cmake-3.17.0</span><br><span class="line">[atguigu@hadoop101 cmake-3.17.0]$ ./bootstrap</span><br></pre></td></tr></table></figure>

<p>（2）执行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 cmake-3.17.0]$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>（3）验证安装是否成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 cmake-3.17.0]$ cmake -version</span><br><span class="line">cmake version 3.17.0</span><br><span class="line">CMake suite maintained and supported by Kitware (kitware.com/cmake).</span><br></pre></td></tr></table></figure>

<p><strong>7）安装protobuf，进入到解压后的protobuf目录</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 protobuf-2.5.0]$ pwd</span><br><span class="line">/opt/module/hadoop_source/protobuf-2.5.0</span><br></pre></td></tr></table></figure>

<p>（1）依次执行下列命令 –prefix 指定安装到当前目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 protobuf-2.5.0]$ ./configure --prefix=/opt/module/hadoop_source/protobuf-2.5.0 </span><br><span class="line">[root@hadoop101 protobuf-2.5.0]$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>（2）配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 protobuf-2.5.0]$ vim /etc/profile.d/my_env.sh</span><br><span class="line">输入如下内容</span><br><span class="line">PROTOC_HOME=/opt/module/hadoop_source/protobuf-2.5.0</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin:$PROTOC_HOME/bin</span><br></pre></td></tr></table></figure>

<p>（3）验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 protobuf-2.5.0]$ source /etc/profile</span><br><span class="line">[root@hadoop101 protobuf-2.5.0]$ protoc --version</span><br><span class="line">libprotoc 2.5.0</span><br></pre></td></tr></table></figure>

<p><strong>8）到此，软件包安装配置工作完成。</strong></p>
<h2 id="6-3-编译源码"><a href="#6-3-编译源码" class="headerlink" title="6.3 编译源码"></a>6.3 编译源码</h2><p>1）进入解压后的Hadoop源码目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 hadoop-3.1.3-src]$ pwd</span><br><span class="line">/opt/module/hadoop_source/hadoop-3.1.3-src</span><br><span class="line"><span class="meta">#</span><span class="bash">开始编译</span></span><br><span class="line">[root@hadoop101 hadoop-3.1.3-src]$ mvn clean package -DskipTests -Pdist,native -Dtar</span><br></pre></td></tr></table></figure>

<p>注意：第一次编译需要下载很多依赖jar包，编译时间会很久，预计1小时左右，最终成功是全部SUCCESS，爽!!! </p>
<p><img src="/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20220808172319416.png" alt="image-20220808172319416"></p>
<p>2）成功的64位hadoop包在/opt/module/hadoop_source/hadoop-3.1.3-src/hadoop-dist/target下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop101 target]# pwd</span><br><span class="line">/opt/module/hadoop_source/hadoop-3.1.3-src/hadoop-dist/target</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Rui Zhang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yoursite.com/2022/08/08/Hadoop%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="Hadoop之源码解析">http://yoursite.com/2022/08/08/Hadoop之源码解析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Hadoop/" rel="tag"># Hadoop</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/08/Hadoop%E4%B9%8B%E7%94%9F%E4%BA%A7%E8%B0%83%E4%BC%98/" rel="prev" title="Hadoop之生产调优">
      <i class="fa fa-chevron-left"></i> Hadoop之生产调优
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/08/11/Hadoop%E4%B9%8BHA%E9%AB%98%E5%8F%AF%E7%94%A8/" rel="next" title="Hadoop之HA高可用">
      Hadoop之HA高可用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第0章-RPC通信原理解析"><span class="nav-number">1.</span> <span class="nav-text">第0章 RPC通信原理解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第1章-NameNode启动源码解析"><span class="nav-number">2.</span> <span class="nav-text">第1章 NameNode启动源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-启动9870端口服务"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 启动9870端口服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-加载镜像文件和编辑日志"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 加载镜像文件和编辑日志</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-初始化NN的RPC服务端"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 初始化NN的RPC服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-NN启动资源检查"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 NN启动资源检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-NN对心跳超时判断"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 NN对心跳超时判断</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-安全模式"><span class="nav-number">2.6.</span> <span class="nav-text">1.6 安全模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第2章-DataNode启动源码解析"><span class="nav-number">3.</span> <span class="nav-text">第2章 DataNode启动源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-初始化DataXceiverServer"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 初始化DataXceiverServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-初始化HTTP服务"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 初始化HTTP服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-初始化DN的RPC服务端"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 初始化DN的RPC服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-DN向NN注册"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 DN向NN注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-向NN发送心跳"><span class="nav-number">3.5.</span> <span class="nav-text">2.5 向NN发送心跳</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第3章-HDFS上传源码解析"><span class="nav-number">4.</span> <span class="nav-text">第3章 HDFS上传源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-create创建过程"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 create创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-DN向NN发起创建请求"><span class="nav-number">4.1.1.</span> <span class="nav-text">3.1.1 DN向NN发起创建请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-NN处理DN的创建请求"><span class="nav-number">4.1.2.</span> <span class="nav-text">3.1.2 NN处理DN的创建请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-DataStreamer启动流程"><span class="nav-number">4.1.3.</span> <span class="nav-text">3.1.3 DataStreamer启动流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-write上传过程"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 write上传过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-向DataStreamer的队列里面写数据"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.1.1 向DataStreamer的队列里面写数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-建立管道之机架感知（块存储位置）"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.1.2 建立管道之机架感知（块存储位置）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-建立管道之Socket发送"><span class="nav-number">4.2.3.</span> <span class="nav-text">3.1.3 建立管道之Socket发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-建立管道之Socket接收"><span class="nav-number">4.2.4.</span> <span class="nav-text">3.1.4 建立管道之Socket接收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-5-客户端接收DN写数据应答Response"><span class="nav-number">4.2.5.</span> <span class="nav-text">3.1.5 客户端接收DN写数据应答Response</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第4章-Yarn源码解析"><span class="nav-number">5.</span> <span class="nav-text">第4章 Yarn源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Yarn客户端向RM提交作业"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 Yarn客户端向RM提交作业</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-RM启动MRAppMaster"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 RM启动MRAppMaster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-调度器任务执行（YarnChild）"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 调度器任务执行（YarnChild）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第5章-MapReduce源码解析"><span class="nav-number">6.</span> <span class="nav-text">第5章 MapReduce源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Job提交流程源码和切片源码详解"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 Job提交流程源码和切片源码详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-MapTask-amp-ReduceTask源码解析"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 MapTask &amp; ReduceTask源码解析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第6章-Hadoop源码编译"><span class="nav-number">7.</span> <span class="nav-text">第6章 Hadoop源码编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-前期准备工作"><span class="nav-number">7.1.</span> <span class="nav-text">6.1 前期准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-工具包安装"><span class="nav-number">7.2.</span> <span class="nav-text">6.2 工具包安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-编译源码"><span class="nav-number">7.3.</span> <span class="nav-text">6.3 编译源码</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rui Zhang"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">Rui Zhang</p>
  <div class="site-description" itemprop="description">不在沉默中爆发，就在沉默中灭亡</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rui Zhang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:10</span>
</div>




        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":120,"height":230},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
